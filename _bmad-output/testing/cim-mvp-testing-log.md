# CIM MVP Testing Log

**Date:** 2026-01-14
**Tester:** Max
**Test Company:** NexusFlow AI (knowledge.json)
**Environment:** localhost:3000 + LangGraph Studio

---

## Test Session Summary

| Step | Stage | Status | Issues Found |
|------|-------|--------|--------------|
| 1 | Welcome | ðŸŸ¡ Partial | #1, #2 |
| 2 | Buyer Persona | âœ… Passed | #4 (minor - prompts need tuning) |
| 3 | Hero Concept | âœ… Passed | |
| 4 | Investment Thesis | âœ… Passed | |
| 5 | Outline | ðŸ”´ Failed | #3 (skipped HITL), #7, #8 |
| 6 | Building Sections | ðŸ”´ Failed | #5 (no interactive design), #6 (broken preview) |
| 7 | Session Persistence | â³ Pending | |

### Critical Issues Summary
| Issue | Severity | Category | Description |
|-------|----------|----------|-------------|
| #3 | ðŸ”´ CRITICAL | Workflow | Outline stage skips HITL approval |
| #5 | ðŸ”´ CRITICAL | Workflow | Slides auto-generated without design process |
| #6 | ðŸ”´ CRITICAL | UI | Preview renders raw JSON, not visual slides |
| #7 | ðŸŸ¡ Medium | Workflow | Section dividers not generated |
| #8 | ðŸŸ¡ Medium | Workflow | No "which section first?" prompt |

---

## Issues Log

### Issue #1: Welcome message is hardcoded, not agent-generated
- **Stage:** Welcome
- **Severity:** ðŸŸ¡ Medium
- **Description:** The welcome message is hardcoded in UI (`CIMMessageList.tsx:100-104`), not generated by the agent
- **Expected:** Agent should be invoked on page load to generate a dynamic welcome that:
  - Checks if knowledge.json is available
  - Greets with company name if found ("Building CIM for NexusFlow AI...")
  - Shows what data is available vs missing
- **Actual:** Static hardcoded message that always says "Tell me about your company" regardless of whether knowledge exists
- **Root Cause:** `CIMMessageList.tsx` prepends a hardcoded `introMessage` to every conversation. Agent is never invoked until user sends first message.
- **Fix Now?** No
- **Fix Options:**
  1. Trigger agent on page load with a `[SYSTEM] Initialize` message
  2. Make welcome message dynamic based on knowledge file check (simpler)
  3. Keep hardcoded but update text to be more accurate

### Issue #2: Workflow stage indicator shows legacy phase
- **Stage:** Welcome
- **Severity:** ðŸŸ¢ Low
- **Description:** UI shows "Phase: executive summary" instead of workflow stage
- **Expected:** Should show current workflow stage (welcome â†’ buyer_persona â†’ hero_concept â†’ etc.)
- **Actual:** Shows legacy CIM phase system
- **Fix Now?** No
- **Notes:** The workflow system (7 stages) and legacy phase system (11 phases) are both present. UI may be displaying the wrong one.

### Issue #3: Agent skips outline stage - jumps directly to building sections
- **Stage:** After investment_thesis
- **Severity:** ðŸ”´ Critical
- **Description:** After accepting the investment thesis, the agent immediately started asking for Executive Summary content instead of:
  1. Proposing an outline structure
  2. Getting user approval on sections
  3. Letting user choose which section to build first
- **Expected Flow (from v3 prototype):**
  1. Propose sections with logical flow reasoning
  2. HITL: "Use this structure as-is / Add-remove-reorder / Suggest different"
  3. After approval: "Which section should we tackle first?"
  4. User picks section, THEN agent starts building that section
- **Actual:** Agent said "Now let me start building the Executive Summary section" and asked for company tagline, founding story, etc.
- **Root Cause:** The `outline` stage prompt doesn't enforce HITL approval before proceeding. Also, `advance_workflow` may be called too early.
- **Fix Required:**
  1. Update `outline` stage prompt to match v3 Phase 3 pattern
  2. Ensure agent waits for explicit user approval before calling `create_outline`
  3. After outline created, agent should ask "Which section should we tackle first?" (v3 Phase 4)
- **Reference:** See `.claude/commands/manda-cim-company-overview-v3.md` Phase 3 & Phase 4
- **Additional Observation:** The outline DID appear in the UI (positive!), but:
  - Generated without user approval (no HITL)
  - Assumed section order (Executive Summary first) without asking user preference
  - Should wait for user to confirm structure AND choose which section to start with

### Issue #4: Prompts need comprehensive review
- **Stage:** All stages
- **Severity:** ðŸŸ¡ Medium
- **Description:** Multiple prompt issues identified during testing:
  - `buyer_persona`: Was too generic, didn't contextualize with company data (partially fixed)
  - `outline`: Doesn't enforce HITL approval flow
  - All stages: Need to follow v3 conversational patterns more closely
- **Action:** Comprehensive prompt review against v3 prototype patterns
- **Status:** Noted for later (after critical issues fixed)

### Issue #5: Slides generated without interactive design process
- **Stage:** building_sections
- **Severity:** ðŸ”´ Critical
- **Description:** Agent auto-generated slides without following the v3 slide creation workflow:
  1. No content-first discussion (v3 Phase 5-6)
  2. No visual design approval (v3 Phase 7)
  3. No HITL at each step
- **Expected Flow (from v3 prototype):**
  1. **Phase 5:** Choose content focus - present 3 options, wait for user decision
  2. **Phase 6:** Build slide content FIRST - present content elements, wait for approval
  3. **Phase 7:** Design visual concept AFTER content approved - detailed layout, wait for approval
  4. Only THEN generate the slide JSON
- **Actual:** Agent said "âœ… Slide 2 Created" and immediately showed completed slides without ANY intermediate approval steps
- **Root Cause:** `building_sections` stage prompt doesn't enforce the content-first â†’ visual-design workflow
- **Fix Required:** Rewrite `building_sections` prompt to match v3 Phase 5-7 pattern

### Issue #6: Slide preview renders raw JSON instead of visual
- **Stage:** building_sections / UI
- **Severity:** ðŸ”´ Critical
- **Description:** The slide preview panel shows:
  - Raw JSON arrays: `[{"label":"ARR","value":"$28.5M"},...]`
  - Unformatted component data instead of rendered visuals
  - Empty table cells with dotted borders
  - Bullet points showing raw array syntax
- **Expected:** Properly rendered slide with:
  - Metrics displayed in styled boxes/badges
  - Formatted text and headings
  - Actual charts/tables (not JSON)
- **Root Cause:** UI component not parsing slide `components` array correctly
- **Files to investigate:**
  - `components/cim-builder/PreviewPanel/SlidePreview.tsx`
  - `components/cim-builder/PreviewPanel/SlideRenderer.tsx` (if exists)
  - Check how `layoutType` and `components` are mapped to visual elements

### Issue #7: Section divider slides missing from outline
- **Stage:** outline â†’ building_sections
- **Severity:** ðŸŸ¡ Medium
- **Description:** When outline is created, section divider slides should be auto-generated and visible in the preview. Currently:
  - Outline appears in left panel (good)
  - But preview shows content slides, not section dividers
- **Expected:** Each section in outline should have a corresponding divider slide in preview
- **Fix:** `create_outline` tool should emit section divider slides (may already be in code but not rendering)

### Issue #8: No "which section first?" prompt after outline
- **Stage:** outline â†’ building_sections transition
- **Severity:** ðŸŸ¡ Medium
- **Description:** After outline is created, agent should ask user which section to work on first (v3 Phase 4). Instead, it assumed Executive Summary.
- **Expected from v3:** "Which section should we tackle first? You can start anywhere - there's no required order."
- **Root Cause:** Part of Issue #3 - outline stage flow broken

---

## Observations

### Positive
- âœ… Knowledge loader works - found NexusFlow AI with 82% data sufficiency
- âœ… All 5 documents detected (company-overview, financials, management-bios, competitive-analysis, investor-deck)
- âœ… Workflow stage transitions work (welcome â†’ buyer_persona)
- âœ… Agent correctly references company name after first message
- âœ… Database sync works (conversation + workflow state saved)
- âœ… SSE streaming works
- âœ… Model swap to Claude Haiku 4.5 works - more natural conversation
- âœ… Outline renders in UI when `create_outline` tool is called
- âœ… Buyer persona, hero concept, investment thesis stages flow correctly

### Needs Improvement
- âš ï¸ **Latency**: First message took 18.1s total (16.1s agent time). Two LLM round-trips with GPT-4o + large context. Consider:
  - Using GPT-4o-mini for faster responses
  - Streaming earlier (show "thinking..." indicator)
  - Caching system prompt compilation
-

---

## LangSmith Trace Links

| Trace ID | Stage | Tools Called | Issue |
|----------|-------|--------------|-------|
| `019bbde3-c4de-788b-b016-2563d0e1ac60` | Welcome | None | âœ… OK |
| `019bbde7-88e9-788b-b016-63d43ed0eb0f` | Buyer Persona | `save_buyer_persona` | âœ… OK |
| `019bbde8-52bb-788b-b017-63c66ec515f4` | Hero Concept | `save_hero_concept` | âœ… OK |
| `019bbde9-28fd-7bb8-81e2-a765d48830de` | **Outline** | `knowledge_search` x4, `create_outline` | ðŸ”´ #3 - No HITL before `create_outline` |
| `019bbdf3-bd9f-7336-9caf-388c1dd4ea4e` | **Building Sections** | `start_section`, `update_slide` x2 | ðŸ”´ #5, #8 - No section choice, no slide design process |

**Analysis:**
- Trace 4 shows `create_outline` called in SAME turn as `knowledge_search` - agent didn't wait for user to approve outline structure
- Trace 5 shows `start_section` + `update_slide` called together - agent didn't ask "which section?" and didn't follow content-first design process
- Dashboard: https://eu.smith.langchain.com

---

## Token Analysis

| Metric | Observed | Target | Status |
|--------|----------|--------|--------|
| Input tokens/request | 57k | 30-40k | ðŸ”´ High |
| Cache hit rate | 0% | >70% | ðŸ”´ No caching |
| Cost/request | $0.05-0.06 | $0.01-0.02 | ðŸŸ¡ Acceptable for MVP |
| TTFT | 2-3s | <1.5s | ðŸŸ¡ Acceptable |

**Root Cause of 0% Cache Hit:**
- LangChain middleware for prompt caching not configured
- System prompt changes slightly each request (dynamic knowledge injection)
- No `cache_control` breakpoints set

**Optimization Plan:** See [cim-builder-architecture-evaluation.md](../planning-artifacts/cim-builder-architecture-evaluation.md#context-engineering--token-optimization-2026-best-practices)

---

## Next Steps (Post-Testing)

### Priority 1: Fix Critical Workflow Issues
1. **Fix Issue #3** - Update `outline` stage prompt to enforce HITL approval
   - Add explicit "Wait for user approval before calling `create_outline`"
   - Reference v3 Phase 3 pattern
2. **Fix Issue #8** - Add "which section first?" prompt after outline approval
   - Part of outline stage rewrite
3. **Fix Issue #5** - Rewrite `building_sections` prompt for interactive slide design
   - Follow v3 Phase 5-7 pattern (content focus â†’ content approval â†’ visual design)

### Priority 2: Fix UI Issues
4. **Fix Issue #6** - Slide preview renders raw JSON
   - Investigate `SlidePreview.tsx` component parsing
   - Check `layoutType` and `components` mapping

### Priority 3: Token Optimization (P0 from architecture doc)
5. **Implement prompt caching** via `anthropicPromptCachingMiddleware`
   - Target: 70%+ cache hit rate
   - Expected cost reduction: 70-90%

### Priority 4: Prompt Review
6. **Comprehensive prompt review** against v3 prototype
   - All stages should follow v3 conversational patterns
   - HITL checkpoints at each decision point

---

## Session Notes

- **Model:** Claude Haiku 4.5 (`claude-haiku-4-5-20251001`)
- **Previous Model:** GPT-4o (swapped in Phase 1)
- **Observation:** Claude feels more natural, but workflow issues are prompt-related, not model-related
