# Epic 2 Retrospective: Intelligent Conversation - Supervisor & Routing

**Date:** 2026-01-10
**Facilitator:** Bob (Scrum Master)
**Participants:** Max (User), Charlie (Senior Dev), Dana (QA Engineer), Elena (Junior Dev), Alice (Product Owner)

---

## Epic Summary

**Epic:** Epic 2 - Intelligent Conversation - Supervisor & Routing
**Status:** COMPLETED
**Stories Completed:** 4 (2.1, 2.2, 2.3, 2.4)

### What Was Delivered

- Supervisor node with LLM-based routing via Gemini/Vertex AI (Story 2.1)
- Real-time token streaming with v2-compliant SSE events (Story 2.2)
- Workflow router middleware with system prompt by mode (Story 2.3)
- Professional response tone guidelines in prompts (Story 2.4)

### Key Metrics

| Metric | Value |
|--------|-------|
| Stories Completed | 4 |
| Unit Tests (v2) | 287+ |
| Code Review Issues Caught | 8 HIGH/MEDIUM across 3 stories |
| All Issues Fixed Before Merge | Yes |
| Epic 1 Action Items Completed | 4/4 (100%) |

---

## What Went Well

1. **LLM-Based Routing Works** - Supervisor node handles greetings and simple queries naturally, routes complex queries to specialists via tool-calling. No more broken regex patterns.

2. **Middleware Infrastructure Ready** - Story 2.3 established the middleware stack with `systemPrompt` field in state. Clean contract between middleware and supervisor. Ready for Epic 3's context-loader.

3. **Token Streaming Enhances, Doesn't Duplicate** - Story 2.2 built on existing `streamAgent()` rather than duplicating infrastructure. Pattern of enhancement over replacement.

4. **100% Follow-Through on Epic 1 Action Items** - All 4 prerequisites (Vertex AI, specialist tools, route consolidation, story updates) completed before Epic 2 started. Pre-work paid off.

5. **Code Reviews Catching Issues** - 3 of 4 stories had HIGH/MEDIUM severity issues caught in review and fixed before merge. Process is working.

---

## What Could Have Gone Better

1. **CIM Phase Type Mismatch** - Discovered v2 types (`content`, `visuals`) don't match legacy types (`content_creation`, `visual_concepts`). Required mapping function as workaround. Should unify.

2. **Assumed "Battle-Tested" Prompts** - Called prompts.ts "battle-tested" but we've never validated with real users. Need to validate assumptions during Epic 3.

3. **Common TypeScript Issues in Review** - Type narrowing, missing fields, unused parameters caught repeatedly. Could automate with stricter lint/TS config.

4. **Vitest Mocking Challenges** - LangChain's complex generic types and graph singleton pattern made unit testing difficult. Adapted test strategy but not ideal.

---

## Technical Decisions Made

| Decision | Context | Outcome |
|----------|---------|---------|
| Gemini via Vertex AI (EU) | NFR8 compliance, cost | Correct - supervisor working |
| v2 token events bypass legacy handler | Avoid breaking changes | Correct - clean SSE format |
| `systemPrompt` in state (not scratchpad) | Type safety, LangSmith visibility | Correct - explicit contract |
| CIM phase mapping function | Type mismatch discovered | Temporary - needs unification |
| Self-hosted Redis (not Upstash/Memorystore) | Cost control, no users yet | Correct for current stage |

---

## Technical Debt Incurred

| Item | Origin | Priority | Resolution |
|------|--------|----------|------------|
| CIM phase type mismatch | Story 2.3 | HIGH | Unify types, remove mapping |
| Upstash Redis client | Previous implementation | HIGH | Migrate to ioredis for self-hosted |
| `intent.ts` cleanup | Epic 1 (carried forward) | LOW | When dependencies refactored |
| Prompts.ts unvalidated | Story 2.4 discussion | MEDIUM | Validate during Epic 3 retrieval work |

---

## Epic 1 Action Items Review

| # | Action Item | Status | Notes |
|---|-------------|--------|-------|
| 1 | Set up Vertex AI credentials and package | âœ… DONE | Commit d6906bb |
| 2 | Define specialist tool interfaces | âœ… DONE | 4 specialists in tools/ |
| 3 | Consolidate routes: delete /chat-v2 â†’ /chat | âœ… DONE | Single entry point |
| 4 | Update Story 2.1 acceptance criteria | âœ… DONE | Pre-requisites section |

**Result:** 100% completion. Pre-work before epic start continues to pay off.

---

## Action Items for Epic 3

| # | Action Item | Priority | Owner | Status | Notes |
|---|-------------|----------|-------|--------|-------|
| 1 | Unify CIM phase types (v2 vs legacy) | HIGH | Dev | âœ… DONE | v2/types.ts re-exports from lib/types/cim.ts, mapping removed |
| 2 | Migrate Redis client from Upstash to ioredis | HIGH | Dev | âœ… DONE | ioredis installed, env var is REDIS_URL, redis in docker-compose |
| 3 | Verify Neo4j + Graphiti stack works with v2 | HIGH | Dev | âœ… DONE | Types verified, kg-expert tool tests pass |
| 4 | Configure stricter TypeScript/ESLint rules | MEDIUM | Dev | âœ… DONE | noFallthroughCasesInSwitch, eslint updated |
| 5 | Validate prompts.ts with real usage | MEDIUM | Dev | ðŸ”œ DEFERRED | For Epic 3 specialist implementation |

---

## Infrastructure Decisions for Epic 3

**Redis Strategy:**
- **Status:** OPTIONAL for Epic 3 development (decision 2026-01-10)
- Code migrated to ioredis (from @upstash/redis) but Redis not required to run
- Cache gracefully falls back to in-memory when REDIS_URL not set
- No Redis usage in lib/agent/v2/ - no interference with LangGraph agent
- Redis can be enabled later via `docker-compose.dev.yml` when needed for testing caching
- Rationale: Reduces development complexity, allows focus on core Epic 3 functionality

**Neo4j/Graphiti:**
- Local dev: Docker via `docker-compose.dev.yml`
- Production: Self-hosted (already planned)
- Need to verify stack works before Story 3-2

---

## Lessons for Future Epics

1. **Front-load blockers** - Completing prerequisites before epic start (Vertex AI, route consolidation) made Story 2.1 smoother. Continue this pattern.

2. **Don't assume existing code is validated** - "Carefully crafted" is not "battle-tested". Validate assumptions with real usage.

3. **Zero tolerance for technical debt** - Don't build v2 around legacy convenience. Unify types, migrate clients, keep it clean.

4. **Enhance, don't duplicate** - Token streaming built on existing `streamAgent()`. Pattern of enhancement over replacement saves time and reduces bugs.

5. **Code reviews work** - HIGH severity issues caught in 3 of 4 stories. Keep the adversarial review process.

---

## Epic 3 Readiness Assessment

### Dependencies Satisfied
- Supervisor node with LLM routing (Story 2.1) âœ…
- Token streaming infrastructure (Story 2.2) âœ…
- Middleware stack with systemPrompt (Story 2.3) âœ…
- Professional tone in prompts (Story 2.4) âœ…

### Blockers to Resolve
- [x] Migrate Redis from Upstash to ioredis âœ… (code ready, Redis optional for dev)
- [x] Verify Neo4j + Graphiti stack with Docker âœ…
- [x] Unify CIM phase types âœ…

**All blockers resolved 2026-01-10. Ready for Epic 3.**

### Course Correction (2026-01-10)
Redis postponed to after core Epic 3 testing. Rationale: reduces dev complexity.
- ioredis code retained with graceful fallback to in-memory
- No interference with v2 agent (verified: no Redis usage in lib/agent/v2/)
- Test mocks updated from @upstash/redis to ioredis

### Open Questions
- None

---

## Sign-Off

Epic 2 retrospective complete. Team is ready to proceed to Epic 3: Knowledge & Retrieval - Deal Intelligence after resolving the 3 blockers listed above.

**Next Steps:**
1. Complete HIGH priority action items (Redis migration, Neo4j verification, CIM types)
2. Begin Epic 3 implementation with Story 3-1: Context Loader Middleware
