# Epic 3 Retrospective: Knowledge & Retrieval - Deal Intelligence

**Date:** 2026-01-11
**Facilitator:** Bob (Scrum Master)
**Participants:** Max (Project Lead), Charlie (Senior Dev), Dana (QA Engineer), Elena (Junior Dev), Alice (Product Owner)

---

## Epic Summary

**Epic:** Epic 3 - Knowledge & Retrieval - Deal Intelligence
**Status:** COMPLETED (core stories done, 2 intentionally deferred)
**Stories Completed:** 3 (3.1, 3.2, 3.3)
**Stories Deferred:** 2 (3.4, 3.5 - intentional deferrals)

### What Was Delivered

- Retrieval node with Graphiti integration and query complexity-based search selection (Story 3.1)
- Source attribution utilities with SSE `source_added` events and API route integration (Story 3.2)
- Honest uncertainty handling with confidence detection and hallucination guardrails (Story 3.3)

### What Was Deferred

- **Story 3-4: Redis Caching** - Deferred per Epic 2 decision (Redis is optional for development)
- **Story 3-5: Deal Summary Generation** - Deferred until user patterns are known

### Key Metrics

| Metric | Value |
|--------|-------|
| Stories Completed | 3/3 (100% of planned work) |
| Stories Deferred | 2 (intentional) |
| Unit Tests Added | 67+ (18 + 26 + 23) |
| Code Review Issues Caught | 9 (Story 3-2) |
| All Issues Fixed Before Merge | Yes |
| Epic 2 Action Items Completed | 4/5 (80% - 1 carried forward) |

---

## What Went Well

1. **Fast Delivery Through Reuse** - "Enhance, don't duplicate" pattern from Epic 2 drove exceptional velocity. All three stories built on existing infrastructure (`callGraphitiSearch`, `SourceCitation` types, SSE streaming).

2. **Graceful Degradation Pattern** - All three stories return empty/defaults instead of throwing errors. Consistent error handling across the epic.

3. **Smart Deferrals** - Redis caching and Deal Summary correctly deferred to focus on core functionality. No wasted effort on premature optimization.

4. **Excellent Documentation** - Story files included detailed Dev Notes with code examples, gotchas, and anti-patterns. Made implementation "paint-by-numbers."

5. **Code Reviews Catching Issues** - Story 3-2 review found 9 issues including HIGH severity "unused function". Process continues to work.

---

## What Could Have Gone Better

1. **Retrieval Node Built But Not Wired** - The retrieval node exists with passing tests but has no edges in the graph. Cannot be tested end-to-end until wired. This created a testing gap.

2. **Context-Loader Dead Code** - Built middleware that was then deferred. Code sat unused in repo. Should have been deleted immediately.

3. **No Manual Testing** - Unit tests pass but no real queries against real deal data. Flying blind on actual user experience.

---

## Technical Decisions Made

| Decision | Context | Outcome |
|----------|---------|---------|
| Defer Redis caching (Story 3-4) | Per Epic 2 decision, Redis optional | Correct - focused on core |
| Defer Deal Summary (Story 3-5) | No user patterns known yet | Correct - avoid premature optimization |
| Retrieval node without edges | Epic 4 will wire via tool-calling | Created testing gap - needs fix |
| Context-loader deferred | Premature optimization, wrong data | Correct decision, but code should be deleted |
| 5-source limit in SSE | Prevent flooding | Correct - reasonable UX |

---

## Technical Debt Incurred

| Item | Origin | Priority | Resolution |
|------|--------|----------|------------|
| Retrieval node not wired | Story 3-1 design | HIGH | Wire before Epic 4 (Action Item #1) |
| Context-loader dead code | Deferral decision | MEDIUM | Delete (Action Item #2) |
| `citation.id` type mismatch | Story 3-1 | LOW | Documented workaround, works fine |
| Prompts.ts unvalidated | Epic 2 (carried forward) | MEDIUM | Needs real users |

---

## Epic 2 Action Items Review

| # | Action Item | Status | Notes |
|---|-------------|--------|-------|
| 1 | Unify CIM phase types | âœ… DONE | v2/types.ts re-exports from lib/types/cim.ts |
| 2 | Migrate Redis to ioredis | âœ… DONE | ioredis installed, REDIS_URL env var |
| 3 | Verify Neo4j + Graphiti stack | âœ… DONE | kg-expert tool tests pass |
| 4 | Configure stricter TS/ESLint | âœ… DONE | noFallthroughCasesInSwitch enabled |
| 5 | Validate prompts.ts with real usage | ðŸ”œ DEFERRED | Still needs real users |

**Result:** 4/5 completed (80%). Item 5 carried forward - blocked on having real users.

---

## Lessons for Future Epics

1. **Don't build infrastructure you can't test mid-sprint** - The retrieval node gap showed that building without wiring creates blind spots. Ensure integration is testable before sprint ends.

2. **Delete unused code immediately** - Don't leave deferred code "for later". Delete it. Story files document the rationale if we need to rebuild.

3. **Manual testing is non-negotiable** - Unit tests are necessary but not sufficient. Real queries against real data reveal issues tests don't catch.

4. **Enhance, don't duplicate** - Continues to drive velocity. Build on existing infrastructure.

5. **Smart deferrals work** - Focus on core functionality, defer optimization until patterns are known.

---

## Action Items for Epic 4

| # | Action Item | Priority | Owner | Status |
|---|-------------|----------|-------|--------|
| 1 | Wire retrieval node for end-to-end testing | HIGH | Charlie (Dev) | TODO |
| 2 | Delete unused context-loader middleware | HIGH | Elena (Dev) | TODO |
| 3 | Manual end-to-end retrieval testing | HIGH | Max (Project Lead) | TODO |
| 4 | Add "integration testable by sprint end" to story template | MEDIUM | Bob (SM) | TODO |
| 5 | Validate prompts.ts with real usage | MEDIUM | Dev | DEFERRED (needs users) |

---

## Epic 4 Preparation Tasks

| # | Task | Owner | Notes |
|---|------|-------|-------|
| 1 | Complete Action Items 1-3 above | Team | Prerequisite for Epic 4 |
| 2 | Review existing specialist tool stubs | Charlie | `document-researcher`, `financial-analyst`, etc. |
| 3 | Verify tool-calling works with supervisor | Charlie | Test supervisor can invoke tools |

---

## Critical Path Before Epic 4

1. **Wire retrieval node** (Action Item #1) - Make retrieval callable from supervisor
2. **Delete dead code** (Action Item #2) - Remove context-loader.ts and tests
3. **Max's manual testing** (Action Item #3) - Run real deal queries, verify sources return

**Epic 4 CANNOT start until all three are complete.**

---

## Team Agreements

- Don't build infrastructure that can't be tested mid-sprint
- Delete unused code rather than keeping it "for later"
- Wire integrations early enough for testing before sprint ends
- Manual testing by project lead before epic completion

---

## Epic 4 Readiness Assessment

### Dependencies Satisfied
- Retrieval node ready (just needs wiring) âœ…
- Source attribution utilities exported âœ…
- Uncertainty detection available âœ…
- Supervisor node with tool-calling ready âœ…

### Blockers to Resolve
- [ ] Wire retrieval node (Action Item #1)
- [ ] Delete context-loader dead code (Action Item #2)
- [ ] Max's manual testing (Action Item #3)

**Status:** NOT READY - complete action items first

---

## Sign-Off

Epic 3 retrospective complete. Team has identified a clear testing gap and defined action items to address it before Epic 4 begins.

**Key Message:** Fast delivery is great, but we must be able to test what we build. Wire integrations, delete dead code, and manually verify before moving on.

**Next Steps:**
1. Charlie wires retrieval node
2. Elena deletes context-loader code
3. Max runs manual testing
4. Begin Epic 4 when all three are complete
