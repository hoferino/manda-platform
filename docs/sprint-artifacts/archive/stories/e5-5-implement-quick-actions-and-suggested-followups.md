# Story E5.5: Implement Quick Actions and Suggested Follow-ups

Status: done

## Story

As an M&A analyst,
I want quick action buttons and suggested follow-up questions,
so that I can efficiently perform common tasks and explore related topics without typing.

## Acceptance Criteria

1. **AC1: Quick Action Buttons Visible** - The chat interface displays quick action buttons in a persistent location (bottom of chat or above input), with the following actions: "Find Contradictions", "Generate Q&A", "Summarize Findings", and "Identify Gaps"
2. **AC2: Quick Action Triggers Tool Call** - Clicking a quick action button sends a pre-formatted message to the agent that triggers the appropriate tool (e.g., "Find Contradictions" triggers `detect_contradictions`, "Generate Q&A" triggers `suggest_questions`)
3. **AC3: Button Loading States** - Quick action buttons show a loading indicator while the agent is processing and prevent duplicate clicks
4. **AC4: Disabled Button States** - Quick action buttons are disabled when conditions aren't met (e.g., no documents uploaded) with a tooltip explaining why
5. **AC5: Suggested Follow-ups Generated** - After each agent response, the system displays 2-3 contextually relevant follow-up question suggestions based on the conversation
6. **AC6: Follow-up Click Populates Input** - Clicking a suggested follow-up question populates the chat input field with the question text, allowing the user to review/edit before submitting
7. **AC7: Follow-up Suggestions Contextual** - Suggested follow-ups are generated by the LLM based on the current response and conversation context (not hardcoded)
8. **AC8: Responsive Button Layout** - Quick actions and follow-up suggestions display correctly on both desktop and mobile viewports

## Tasks / Subtasks

- [x] Task 1: Create QuickActions component (AC: 1, 3, 4)
  - [x] Create `components/chat/QuickActions.tsx` with action button grid
  - [x] Define quick action configurations: label, icon, prompt, toolName
  - [x] Implement button loading state with spinner icon
  - [x] Implement disabled state with tooltip via Tooltip component
  - [x] Add data-testid attributes for testing
  - [x] Support ARIA labels for accessibility

- [x] Task 2: Implement quick action tool triggers (AC: 2)
  - [x] Create quick action prompt templates for each action:
    - "Find Contradictions" → "Please scan for any contradictions or conflicting information in the documents."
    - "Generate Q&A" → "Generate Q&A suggestions based on the current deal context."
    - "Summarize Findings" → "Please summarize the key findings from the uploaded documents."
    - "Identify Gaps" → "What information gaps exist against the IRL checklist?"
  - [x] Wire onClick handlers to call the existing `sendMessage` function from useChat hook
  - [x] Ensure agent receives the prompt and selects appropriate tool

- [x] Task 3: Integrate QuickActions into ChatInterface (AC: 1, 2)
  - [x] Add QuickActions component above ChatInput
  - [x] Pass sendMessage callback for triggering actions
  - [x] Pass isLoading state to disable during agent processing
  - [x] Pass project context to enable/disable based on document state

- [x] Task 4: Create FollowUpSuggestions component (AC: 5, 6, 8)
  - [x] Create `components/chat/FollowUpSuggestions.tsx`
  - [x] Display 2-3 suggestion chips/buttons below agent responses
  - [x] Implement click handler that populates input via callback
  - [x] Style with subtle background, rounded corners, hover state
  - [x] Implement responsive layout (horizontal scroll on mobile)
  - [x] Add fade-in animation for appearance

- [x] Task 5: Implement LLM-generated follow-up suggestions (AC: 7)
  - [x] Extend chat API response to include `suggested_followups: string[]` (already existed in streaming.ts)
  - [x] Update agent executor to generate follow-ups after each response (already existed)
  - [x] Add follow-up generation to system prompt or as post-processing step (uses generateFollowupSuggestions)
  - [x] Limit to 3 suggestions max (capped in generateFollowupSuggestions)
  - [x] Store follow-ups in message metadata for persistence

- [x] Task 6: Update ChatInterface with follow-up suggestions (AC: 5, 6)
  - [x] Track current suggestions in state (added to useChat hook)
  - [x] Display FollowUpSuggestions after latest assistant message
  - [x] Implement callback to populate input field on click
  - [x] Clear suggestions when new message is sent
  - [x] Update suggestions when new response arrives

- [x] Task 7: Implement quick action availability checks (AC: 4)
  - [x] Create `useQuickActionAvailability` hook
  - [x] Check for documents uploaded before enabling most actions
  - [x] Check for findings before enabling "Summarize Findings"
  - [x] Check for IRL existence before enabling "Identify Gaps"
  - [x] Return disabled states with reason messages

- [x] Task 8: Testing and verification (AC: all)
  - [x] Write component tests for QuickActions (22 tests passing)
  - [x] Write component tests for FollowUpSuggestions (17 tests passing)
  - [x] Write hook tests for useQuickActionAvailability (12 tests passing)
  - [x] Verify responsive layout on mobile viewport
  - [x] Verify build passes with all changes

## Dev Notes

### Relevant Architecture Patterns and Constraints

This story adds a UX enhancement layer on top of the existing chat infrastructure from E5.3 and E5.4. The quick actions are essentially pre-formatted prompts that trigger the agent's tool selection logic (E5.2).

**Key Architecture Constraints:**
- **Reuse Existing Infrastructure:** Use the `useChat` hook's `sendMessage` function for quick actions
- **Agent Handles Tool Selection:** Quick action prompts should be phrased to trigger the appropriate tool, not bypass the agent
- **SSE Streaming:** Follow-up suggestions should be extracted from the final SSE event, not block streaming
- **P3 Compliance:** Quick action prompts should align with the inferred intent patterns from agent-behavior-spec.md

**Quick Action → Tool Mapping:**
| Quick Action | Expected Tool | Intent Pattern |
|--------------|---------------|----------------|
| Find Contradictions | `detect_contradictions` | Due diligence check |
| Generate Q&A | `suggest_questions` | Gap identification |
| Summarize Findings | `query_knowledge_base` | Synthesis |
| Identify Gaps | `find_gaps` | Gap identification |

[Source: docs/agent-behavior-spec.md#P3: Expected Behavior per Use Case]

### Existing Components to Leverage

**From E5.3 (Chat Interface):**
```typescript
// components/chat/ChatInterface.tsx - main container
// hooks/useChat.ts - sendMessage function
interface UseChatReturn {
  messages: Message[];
  isLoading: boolean;
  sendMessage: (content: string) => Promise<void>;
  // ...
}
```

**From E5.4 (Source Citations):**
- Citation styling patterns can be adapted for suggestion chips
- Button hover states from SourceCitationLink

**From E5.2 (Agent Tools):**
```typescript
// Agent tools that quick actions should trigger:
// - detect_contradictions(topic)
// - suggest_questions(topic, max_count)
// - query_knowledge_base(query, filters)
// - find_gaps(category)
```

[Source: manda-app/lib/hooks/useChat.ts]
[Source: manda-app/lib/agent/tools/]

### TypeScript Types

```typescript
// components/chat/QuickActions.tsx
interface QuickAction {
  id: string;
  label: string;
  icon: LucideIcon;
  prompt: string;
  toolName: string;  // For analytics/tracking
  requiresDocuments?: boolean;
  requiresFindings?: boolean;
  requiresIRL?: boolean;
}

// components/chat/FollowUpSuggestions.tsx
interface FollowUpSuggestionsProps {
  suggestions: string[];
  onSelect: (suggestion: string) => void;
  isVisible: boolean;
}

// Extended ChatResponse (from useChat)
interface ChatResponse {
  message: Message;
  conversation_id: string;
  suggested_followups?: string[];  // NEW
}
```

### Project Structure Notes

- New `components/chat/QuickActions.tsx` - quick action button grid
- New `components/chat/FollowUpSuggestions.tsx` - follow-up suggestion chips
- New `lib/hooks/useQuickActionAvailability.ts` - availability checking hook
- Modified `components/chat/ChatInterface.tsx` - integrate components
- Modified `lib/hooks/useChat.ts` - handle suggested_followups in response
- Modified `app/api/projects/[id]/chat/route.ts` - include follow-ups in response
- Tests in `__tests__/components/chat/` following established patterns

### Learnings from Previous Story

**From Story e5-4-implement-source-citation-display-in-messages (Status: done)**

- **Chat Components Structure**: Full `components/chat/` module exists with consistent patterns:
  - `ChatInterface.tsx` - main container with state management
  - `MessageItem.tsx` - message rendering with markdown support
  - `ChatInput.tsx` - input handling with keyboard shortcuts
  - Use same styling conventions for consistency

- **Component Styling Patterns**:
  - Hover states: `hover:underline`, `hover:bg-muted`
  - Touch targets: min-height 28px for mobile
  - Responsive design: `max-w-full truncate` patterns

- **SSE Streaming Integration**:
  - Final message arrives via `done` event type
  - Can extract `suggested_followups` from this event
  - State updates trigger re-renders cleanly

- **Testing Patterns**: 60 tests in E5.4 following patterns:
  - Component tests with React Testing Library
  - Mock Supabase and API calls
  - Accessibility testing with ARIA checks

- **Dependencies Available**: shadcn/ui components (Button, Tooltip, etc.) already installed

[Source: docs/sprint-artifacts/stories/e5-4-implement-source-citation-display-in-messages.md#Dev-Agent-Record]

### References

- [Source: docs/sprint-artifacts/tech-spec-epic-E5.md#Module 5: Chat UI Components]
- [Source: docs/epics.md#Story E5.5: Implement Quick Actions and Suggested Follow-ups]
- [Source: docs/agent-behavior-spec.md#P3: Expected Behavior per Use Case]
- [Source: manda-app/components/chat/ChatInterface.tsx]
- [Source: manda-app/lib/hooks/useChat.ts]
- [Source: manda-app/lib/agent/tools/]

## Dev Agent Record

### Context Reference

- [docs/sprint-artifacts/stories/e5-5-implement-quick-actions-and-suggested-followups.context.xml](e5-5-implement-quick-actions-and-suggested-followups.context.xml)

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None

### Completion Notes List

- Created QuickActions component with 4 quick action buttons (Find Contradictions, Generate Q&A, Summarize Findings, Identify Gaps)
- Each action sends a pre-formatted prompt to trigger the appropriate agent tool
- Implemented loading states with spinner icons during agent processing
- Implemented disabled states with tooltips explaining why (e.g., "Upload documents first")
- Created FollowUpSuggestions component displaying contextual follow-up question chips
- Clicking a suggestion populates the chat input field, allowing user to review before sending
- Extended useChat hook to expose suggestedFollowups state from SSE done events
- Added clearSuggestions function to clear suggestions when new message is sent
- Created useQuickActionAvailability hook that checks document/findings/IRL state in Supabase
- Integrated both components into ChatInterface above the input area
- Updated ChatInput to support initialValue and onValueChange for controlled input
- Responsive design: buttons wrap on mobile, labels hidden on small screens, horizontal scroll for suggestions
- All components have comprehensive ARIA labels and data-testid attributes
- 51 tests passing across 3 test files

### File List

**New Files:**
- `manda-app/components/chat/QuickActions.tsx` - Quick action buttons component
- `manda-app/components/chat/FollowUpSuggestions.tsx` - Follow-up suggestion chips component
- `manda-app/lib/hooks/useQuickActionAvailability.ts` - Availability checking hook
- `manda-app/__tests__/components/chat/QuickActions.test.tsx` - 22 tests
- `manda-app/__tests__/components/chat/FollowUpSuggestions.test.tsx` - 17 tests
- `manda-app/__tests__/lib/hooks/useQuickActionAvailability.test.ts` - 12 tests

**Modified Files:**
- `manda-app/components/chat/ChatInterface.tsx` - Integrated QuickActions and FollowUpSuggestions
- `manda-app/components/chat/ChatInput.tsx` - Added initialValue/onValueChange props
- `manda-app/lib/hooks/useChat.ts` - Added suggestedFollowups state, clearSuggestions function

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2025-12-02 | Story drafted from epics.md and tech-spec-epic-E5.md | SM Agent |
| 2025-12-02 | Story context generated, status updated to ready-for-dev | story-context workflow |
| 2025-12-02 | Story implemented: QuickActions, FollowUpSuggestions, useQuickActionAvailability, 51 tests passing | Dev Agent |
