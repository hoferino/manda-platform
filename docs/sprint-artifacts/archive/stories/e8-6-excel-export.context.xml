<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>E8</epicId>
    <storyId>6</storyId>
    <title>Excel Export</title>
    <status>drafted</status>
    <generatedAt>2025-12-09</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/stories/e8-6-excel-export.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>an analyst</asA>
    <iWant>to export my Q&A list to a professionally formatted Excel file</iWant>
    <soThat>I can send it to the client for answers in a familiar, editable format</soThat>
    <tasks>
      <task n="1" name="Create Q&A Export Service" ac="1,2,3,6">
        <subtask n="1.1">Create lib/services/qa-export.ts with generateQAExcel() function</subtask>
        <subtask n="1.2">Use exceljs (already installed from E4.10) for Excel generation</subtask>
        <subtask n="1.3">Define columns: Question (wide), Priority, Answer (wide), Date Answered</subtask>
        <subtask n="1.4">Group items by category with styled category header rows</subtask>
        <subtask n="1.5">Apply priority color coding (High=red, Medium=yellow, Low=green text)</subtask>
        <subtask n="1.6">Apply professional styling: bold headers, gray background, freeze top row</subtask>
        <subtask n="1.7">Set appropriate column widths (Question: 60, Priority: 12, Answer: 50, Date: 18)</subtask>
        <subtask n="1.8">Write unit tests for export service (mock exceljs, verify structure)</subtask>
      </task>
      <task n="2" name="Create Export API Route" ac="1,4,5">
        <subtask n="2.1">Create app/api/projects/[id]/qa/export/route.ts</subtask>
        <subtask n="2.2">Accept query parameters: category, priority, status (pending|answered|all)</subtask>
        <subtask n="2.3">Fetch Q&A items using existing getQAItems() service with filters</subtask>
        <subtask n="2.4">Generate Excel buffer using generateQAExcel()</subtask>
        <subtask n="2.5">Fetch project name for filename from deals table</subtask>
        <subtask n="2.6">Sanitize company name for filename (replace special chars with dash)</subtask>
        <subtask n="2.7">Set response headers: Content-Type, Content-Disposition, Content-Length</subtask>
        <subtask n="2.8">Return Excel file as blob response</subtask>
        <subtask n="2.9">Write API route tests (verify status codes, headers, filter application)</subtask>
      </task>
      <task n="3" name="Add Export Function to Client API" ac="1">
        <subtask n="3.1">Add exportQAToExcel() function to lib/api/qa.ts</subtask>
        <subtask n="3.2">Accept filters parameter matching QAFilters type</subtask>
        <subtask n="3.3">Return blob with filename extracted from Content-Disposition header</subtask>
        <subtask n="3.4">Trigger browser download using anchor element method</subtask>
        <subtask n="3.5">Write unit tests for client function</subtask>
      </task>
      <task n="4" name="Create Export Button Component" ac="4">
        <subtask n="4.1">Create components/qa/QAExportButton.tsx</subtask>
        <subtask n="4.2">Accept current filters as props</subtask>
        <subtask n="4.3">Show loading state during export (spinner on button)</subtask>
        <subtask n="4.4">Display success toast with filename after download</subtask>
        <subtask n="4.5">Display error toast if export fails</subtask>
        <subtask n="4.6">Use Download icon from lucide-react</subtask>
        <subtask n="4.7">Write component tests (click, loading, error states)</subtask>
      </task>
      <task n="5" name="Integrate Export into Q&A Management UI" ac="4">
        <subtask n="5.1">Add QAExportButton to QA page toolbar (next to filter controls)</subtask>
        <subtask n="5.2">Pass current filter state from useQAItems hook to export button</subtask>
        <subtask n="5.3">Ensure export respects active filters</subtask>
        <subtask n="5.4">Test integration end-to-end (manual verification)</subtask>
      </task>
      <task n="6" name="Category Grouping Implementation" ac="3">
        <subtask n="6.1">In export service, group Q&A items by category</subtask>
        <subtask n="6.2">Add category header row before each group (merged cells, bold, background color)</subtask>
        <subtask n="6.3">Sort categories in consistent order: Financials, Legal, Operations, Market, Technology, HR</subtask>
        <subtask n="6.4">Add item count per category in header row</subtask>
        <subtask n="6.5">Add blank row after each category section for readability</subtask>
        <subtask n="6.6">Write tests verifying grouping structure</subtask>
      </task>
      <task n="7" name="Empty Answer Handling" ac="7">
        <subtask n="7.1">For items where date_answered is NULL, leave Answer and Date Answered cells empty</subtask>
        <subtask n="7.2">Add light gray background or pending placeholder style for empty answer cells</subtask>
        <subtask n="7.3">Ensure cells are unlocked/editable for client input</subtask>
        <subtask n="7.4">Write tests verifying pending items have empty answer columns</subtask>
      </task>
      <task n="8" name="Verify Build and Run Tests" ac="all">
        <subtask n="8.1">Run npm run build - verify no TypeScript errors</subtask>
        <subtask n="8.2">Run unit tests for export service</subtask>
        <subtask n="8.3">Run component tests for QAExportButton</subtask>
        <subtask n="8.4">Run API route tests</subtask>
        <subtask n="8.5">Manual E2E test: export filtered Q&A list, verify Excel content</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">GET /api/projects/[id]/qa/export endpoint returns a valid .xlsx file</criterion>
    <criterion id="AC2">Excel file columns are: Question | Priority | Answer | Date Answered (in that order)</criterion>
    <criterion id="AC3">Rows are grouped by category with styled section headers (Financials, Legal, Operations, Market, Technology, HR)</criterion>
    <criterion id="AC4">Filter parameters (category, priority, status) apply before export - only matching items included</criterion>
    <criterion id="AC5">Filename follows pattern: {company_name}_QA_List_{YYYY-MM-DD}.xlsx</criterion>
    <criterion id="AC6">Professional formatting applied: styled headers, freeze panes, appropriate column widths, priority color-coding</criterion>
    <criterion id="AC7">Empty Answer and Date Answered columns for pending items (ready for client to fill)</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-E8.md</path>
        <title>Epic 8 Technical Specification</title>
        <section>E8.6: Excel Export (AC-8.6.1 through AC-8.6.5)</section>
        <snippet>Export Q&A list to Excel with category grouping, column structure (Question|Priority|Answer|Date), filename pattern, filter support, and professional formatting.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/epics/epic-E8.md</path>
        <title>Epic 8: Q&A Co-Creation Workflow</title>
        <section>E8.6 Export</section>
        <snippet>Story E8.6 delivers Excel export functionality with category grouping and professional formatting for client distribution.</snippet>
      </doc>
      <doc>
        <path>docs/manda-architecture.md</path>
        <title>Manda Platform Architecture</title>
        <section>API Layer</section>
        <snippet>Next.js API routes at /api/projects/[id]/* pattern proxying to services. File exports return blob responses with proper headers.</snippet>
      </doc>
    </docs>

    <code>
      <file>
        <path>manda-app/lib/types/qa.ts</path>
        <kind>types</kind>
        <symbol>QAItem, QACategory, QAPriority, QAFilters, QA_CATEGORIES</symbol>
        <lines>1-371</lines>
        <reason>Core Q&A types and constants including category definitions and priority config used for export structure</reason>
      </file>
      <file>
        <path>manda-app/lib/services/qa.ts</path>
        <kind>service</kind>
        <symbol>getQAItems, getQASummary</symbol>
        <lines>101-140</lines>
        <reason>Q&A service functions to fetch items with filters - reuse for export</reason>
      </file>
      <file>
        <path>manda-app/lib/api/qa.ts</path>
        <kind>api-client</kind>
        <symbol>getQAItems, QAFilters</symbol>
        <lines>81-113</lines>
        <reason>Client-side API functions to extend with exportQAToExcel()</reason>
      </file>
      <file>
        <path>manda-app/app/api/projects/[id]/findings/export/route.ts</path>
        <kind>api-route</kind>
        <symbol>generateExcel, POST</symbol>
        <lines>190-318</lines>
        <reason>Reference pattern for Excel export using exceljs - styling, colors, freeze panes, blob response</reason>
      </file>
      <file>
        <path>manda-app/lib/services/irl-export.ts</path>
        <kind>service</kind>
        <symbol>groupItemsByCategory, PRIORITY_COLORS, PRIORITY_LABELS</symbol>
        <lines>55-86</lines>
        <reason>Reference pattern for category grouping logic and priority color mapping</reason>
      </file>
      <file>
        <path>manda-app/components/qa/QAPageClient.tsx</path>
        <kind>component</kind>
        <symbol>QAPageClient</symbol>
        <lines>178-251</lines>
        <reason>Q&A management page where export button will be added to toolbar</reason>
      </file>
      <file>
        <path>manda-app/components/qa/QAFilterBar.tsx</path>
        <kind>component</kind>
        <symbol>QAFilterBar</symbol>
        <reason>Filter controls component - export button should respect these filters</reason>
      </file>
      <file>
        <path>manda-app/lib/hooks/useQAItems.ts</path>
        <kind>hook</kind>
        <symbol>useQAItems</symbol>
        <reason>Hook providing Q&A data and filter state to pass to export</reason>
      </file>
    </code>

    <dependencies>
      <node>
        <package>exceljs</package>
        <version>^4.4.0</version>
        <purpose>Excel file generation (already installed from E4)</purpose>
      </node>
      <node>
        <package>date-fns</package>
        <version>^3.0.0</version>
        <purpose>Date formatting for filename and Date Answered column</purpose>
      </node>
      <node>
        <package>lucide-react</package>
        <version>installed</version>
        <purpose>Download icon for export button</purpose>
      </node>
      <node>
        <package>sonner</package>
        <version>installed</version>
        <purpose>Toast notifications for success/error feedback</purpose>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="pattern">Use lib/services/ pattern for export logic (qa-export.ts separate from qa.ts CRUD)</constraint>
    <constraint type="pattern">API route at app/api/projects/[id]/qa/export/route.ts - GET method only</constraint>
    <constraint type="library">Use exceljs for Excel generation - do NOT use xlsx or SheetJS</constraint>
    <constraint type="styling">Priority colors: high=#DC2626, medium=#F59E0B, low=#10B981 (match IRL/findings exports)</constraint>
    <constraint type="columns">Column widths: Question=60, Priority=12, Answer=50, Date Answered=18</constraint>
    <constraint type="order">Category order: Financials, Legal, Operations, Market, Technology, HR (fixed)</constraint>
    <constraint type="filename">Pattern: {company_name}_QA_List_{YYYY-MM-DD}.xlsx - sanitize special chars to dashes</constraint>
    <constraint type="response">Return blob with Content-Type application/vnd.openxmlformats-officedocument.spreadsheetml.sheet</constraint>
    <constraint type="testing">Write unit tests for service, component tests for button, API route tests</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>GET /api/projects/[id]/qa/export</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/projects/{projectId}/qa/export?category=&amp;priority=&amp;status=</signature>
      <path>manda-app/app/api/projects/[id]/qa/export/route.ts</path>
    </interface>
    <interface>
      <name>generateQAExcel</name>
      <kind>function</kind>
      <signature>async function generateQAExcel(items: QAItem[], projectName: string): Promise&lt;Buffer&gt;</signature>
      <path>manda-app/lib/services/qa-export.ts</path>
    </interface>
    <interface>
      <name>exportQAToExcel</name>
      <kind>function</kind>
      <signature>async function exportQAToExcel(projectId: string, filters?: QAFilters): Promise&lt;void&gt;</signature>
      <path>manda-app/lib/api/qa.ts</path>
    </interface>
    <interface>
      <name>QAExportButton</name>
      <kind>React component</kind>
      <signature>function QAExportButton({ projectId, filters }: { projectId: string; filters?: QAFilters }): JSX.Element</signature>
      <path>manda-app/components/qa/QAExportButton.tsx</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Vitest for unit/integration tests, React Testing Library for components.
      Follow existing patterns in __tests__/ directory structure.
      Mock exceljs in service tests to verify structure without file I/O.
      API route tests use Next.js test helpers with mocked Supabase.
    </standards>
    <locations>
      <location>manda-app/__tests__/lib/services/qa-export.test.ts</location>
      <location>manda-app/__tests__/components/qa/QAExportButton.test.tsx</location>
      <location>manda-app/__tests__/app/api/projects/qa-export.test.ts</location>
    </locations>
    <ideas>
      <idea ac="1">Test generateQAExcel returns valid Excel buffer with correct headers</idea>
      <idea ac="2">Test column structure matches spec: Question, Priority, Answer, Date Answered</idea>
      <idea ac="3">Test items are grouped by category in correct order with header rows</idea>
      <idea ac="4">Test API route applies filters before generating export</idea>
      <idea ac="5">Test filename pattern with sanitized company name and date</idea>
      <idea ac="6">Test styling: header row frozen, priority colors applied, column widths set</idea>
      <idea ac="7">Test pending items (date_answered=null) have empty Answer/Date columns</idea>
      <idea ac="4">Test QAExportButton loading state, success toast, error handling</idea>
    </ideas>
  </tests>
</story-context>
