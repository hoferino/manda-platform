<story-context id="bmad/bmm/workflows/4-implementation/story-context/e1-3" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.3</storyId>
    <title>Create PostgreSQL Schema with RLS Policies</title>
    <status>drafted</status>
    <generatedAt>2025-11-24</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/stories/e1-3-create-postgresql-schema-with-rls-policies.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>a complete PostgreSQL database schema with Row-Level Security (RLS) policies enforcing data isolation</iWant>
    <soThat>users can only access their own data and the system has a solid foundation for all future features</soThat>
    <tasks>
- [ ] Task 1: Set Up Database Migration Tool (AC: #1)
- [ ] Task 2: Enable pgvector Extension (AC: #6)
- [ ] Task 3: Create Deals Table (AC: #2, #3)
- [ ] Task 4: Create Documents Table (AC: #2, #3, #4)
- [ ] Task 5: Create Findings Table with pgvector (AC: #2, #3, #6)
- [ ] Task 6: Create Insights Table (AC: #2, #3)
- [ ] Task 7: Create Conversations and Messages Tables (AC: #2, #3)
- [ ] Task 8: Create IRLs Table (AC: #2, #3)
- [ ] Task 9: Create Q&A Lists Table (AC: #2, #3)
- [ ] Task 10: Create CIMs Table (AC: #2, #3)
- [ ] Task 11: Add Updated_at Triggers (AC: #2)
- [ ] Task 12: Generate TypeScript Types (AC: #2)
- [ ] Task 13: RLS Testing (AC: #3, #8)
- [ ] Task 14: Performance Testing (AC: #5)
- [ ] Task 15: Documentation (AC: All)
    </tasks>
  </story>

  <acceptanceCriteria>
### AC1: Database Migration Setup
**Given** the database connection is configured (E1.2)
**When** I run database migrations
**Then** all tables are created in the correct order
**And** Foreign key constraints are enforced
**And** Indexes are created on all foreign keys and query-heavy columns
**And** pgvector extension is enabled

### AC2: Core Tables Creation
**Given** the migration runs successfully
**When** I inspect the database schema
**Then** I see all 9 core tables: deals, documents, findings, insights, conversations, messages, irls, qa_lists, cims
**And** All tables have proper primary keys (UUID)
**And** All tables have created_at and updated_at timestamps
**And** All tables have user_id foreign key to auth.users

### AC3: Row-Level Security Policies
**Given** RLS is enabled on all tables
**When** User A queries the deals table
**Then** User A sees only their own deals
**And** User A cannot query User B's deals
**When** User A tries to INSERT a deal with User B's user_id
**Then** the database rejects the operation
**When** User A tries to UPDATE User B's deal
**Then** the database rejects the operation

### AC4: Foreign Key Constraints
**Given** the schema is created
**When** I try to insert a document with invalid deal_id
**Then** the database rejects with foreign key constraint violation
**When** I delete a deal
**Then** all related documents, findings, insights are cascade deleted
**And** No orphaned records remain

### AC5: Indexes and Performance
**Given** indexes are created
**When** I query deals by user_id
**Then** the query uses the index (verified with EXPLAIN)
**And** Query completes in <100ms (NFR-PERF-003)
**When** I query findings with pgvector similarity search
**Then** the vector index is used
**And** Semantic search completes in <500ms

### AC6: pgvector Configuration
**Given** pgvector extension is installed
**When** I create a finding with an embedding vector
**Then** the vector is stored in the embedding column
**And** I can perform similarity search using <=> operator
**And** Vector dimensions match embedding model (1536 for text-embedding-3-large)

### AC7: Data Validation Constraints
**Given** validation constraints are defined
**When** I try to insert a deal without a name
**Then** the database rejects with NOT NULL constraint violation
**When** I try to insert a deal with invalid status value
**Then** the database rejects with CHECK constraint violation (if defined)

### AC8: Multi-User Data Isolation Test
**Given** two test users (Alice and Bob) with authenticated sessions
**When** Alice creates 3 deals and Bob creates 2 deals
**Then** Alice's query returns exactly 3 deals
**And** Bob's query returns exactly 2 deals
**And** Neither can see the other's deals
**When** Alice tries to access Bob's deal directly by ID
**Then** the query returns 0 rows (RLS policy blocks access)
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <artifact>
        <path>docs/manda-architecture.md</path>
        <title>Manda Architecture Document</title>
        <section>Data Architecture</section>
        <snippet>PostgreSQL 18 with pgvector 0.8+ extension for semantic search. RLS policies use auth.uid() function to identify current user and filter queries automatically. All tables follow pattern: POLICY FOR ALL USING (auth.uid() = user_id). Database-level enforcement ensures even if application code has bugs, users cannot access each other's data.</snippet>
      </artifact>
      <artifact>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>Data Models and Contracts</section>
        <snippet>Deals table with user_id, name, company_name, industry, deal_type, status, irl_template. Documents table with deal_id, file_path, processing_status. Findings table with embedding vector(1536) for pgvector semantic search. All tables enforce RLS policies: ALTER TABLE ENABLE ROW LEVEL SECURITY; CREATE POLICY isolation_policy FOR ALL USING (auth.uid() = user_id).</snippet>
      </artifact>
      <artifact>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>NFR-SEC-002: Row-Level Security</section>
        <snippet>All tables enforce RLS policies (no exceptions). Users can ONLY access their own deals (enforced at database level). RLS policy: auth.uid() = user_id on all multi-tenant tables. Database-level isolation prevents data leaks even if application code fails. No admin bypass in MVP (all access goes through RLS).</snippet>
      </artifact>
      <artifact>
        <path>docs/manda-architecture.md</path>
        <title>Manda Architecture Document</title>
        <section>PostgreSQL Schema</section>
        <snippet>Key Tables: deals (deal metadata), documents (document tracking), findings (extracted facts with embeddings using pgvector), insights (analyzed patterns), conversations (chat history with LangGraph state), messages, irls, qa_lists, cims. Security: Row-Level Security (RLS) on all tables. Users can only access their own deals. Database enforces isolation.</snippet>
      </artifact>
    </docs>
    <code>
      <!-- No existing code artifacts - E1.2 establishes database connection -->
    </code>
    <dependencies>
      <database>
        <extension name="pgvector" version="0.8+" />
        <extension name="uuid-ossp" version="latest" />
      </database>
      <tools>
        <package name="supabase" version="latest" note="Supabase CLI for migrations" />
      </tools>
    </dependencies>
  </artifacts>

  <constraints>
- All tables must enable RLS (no exceptions)
- RLS policy pattern: FOR ALL USING (auth.uid() = user_id)
- All tables must have user_id foreign key to auth.users
- UUID primary keys for all tables (gen_random_uuid())
- Cascade DELETE for related records (no orphans)
- Index all foreign keys and query-heavy columns
- pgvector dimensions: 1536 (text-embedding-3-large)
- Migration tool: Supabase CLI or dbmate
- Idempotent migrations (IF NOT EXISTS)
  </constraints>

  <interfaces>
    <database>
      <table>deals</table>
      <description>Project/deal metadata with RLS isolation</description>
      <columns>id uuid PRIMARY KEY, user_id uuid REFERENCES auth.users(id), name text NOT NULL, company_name text, industry text, deal_type text, status text DEFAULT 'active', irl_template text, created_at timestamptz, updated_at timestamptz</columns>
      <rls_policy>CREATE POLICY deals_isolation_policy ON deals FOR ALL USING (auth.uid() = user_id)</rls_policy>
    </database>
    <database>
      <table>findings</table>
      <description>Extracted facts with pgvector embeddings</description>
      <columns>id uuid PRIMARY KEY, deal_id uuid REFERENCES deals(id) ON DELETE CASCADE, document_id uuid REFERENCES documents(id) ON DELETE CASCADE, user_id uuid REFERENCES auth.users(id), text text NOT NULL, embedding vector(1536), confidence float, metadata jsonb, created_at timestamptz</columns>
      <rls_policy>CREATE POLICY findings_isolation_policy ON findings FOR ALL USING (auth.uid() = user_id)</rls_policy>
    </database>
  </interfaces>

  <tests>
    <standards>
Testing standards per Epic 1 Tech Spec: Jest for unit tests, custom SQL scripts for database testing. Database migration tests: up/down idempotence. RLS tests: multi-user isolation verification. Performance tests: query times with realistic data volumes. Security tests: cross-user access attempts (should fail).
    </standards>
    <locations>
- Migration files: `supabase/migrations/` or `db/migrations/`
- Test scripts: `scripts/test-rls.ts`, `scripts/test-performance.ts`
- Integration tests: `__tests__/database/` for schema validation
    </locations>
    <ideas>
      <test ac_id="AC1">
- Test: Migration up creates all tables in correct order
- Test: Migration down removes all tables
- Test: Migration is idempotent (can run multiple times)
      </test>
      <test ac_id="AC2">
- Test: All 9 tables exist after migration
- Test: All tables have UUID primary keys
- Test: All tables have created_at and updated_at
- Test: All tables have user_id foreign key
      </test>
      <test ac_id="AC3">
- Test: User A can SELECT only their own deals
- Test: User A cannot SELECT User B's deals
- Test: User A cannot INSERT with User B's user_id
- Test: User A cannot UPDATE User B's deals
- Test: User A cannot DELETE User B's deals
      </test>
      <test ac_id="AC4">
- Test: INSERT document with invalid deal_id fails
- Test: DELETE deal cascades to documents, findings, insights
- Test: No orphaned records after cascade delete
      </test>
      <test ac_id="AC5">
- Test: Query by user_id uses index (EXPLAIN ANALYZE)
- Test: Query completes in <100ms with 100 deals
- Test: Vector search uses ivfflat index
- Test: Vector search completes in <500ms
      </test>
      <test ac_id="AC6">
- Test: Insert finding with embedding vector(1536)
- Test: Vector similarity search with <=> operator
- Test: Vector dimensions match embedding model
      </test>
      <test ac_id="AC7">
- Test: INSERT deal without name fails (NOT NULL)
- Test: INSERT deal with invalid status fails (CHECK constraint if defined)
      </test>
      <test ac_id="AC8">
- Test: Alice creates 3 deals, Bob creates 2 deals
- Test: Alice sees exactly 3 deals
- Test: Bob sees exactly 2 deals
- Test: Alice cannot access Bob's deal by ID (0 rows)
      </test>
    </ideas>
  </tests>
</story-context>
