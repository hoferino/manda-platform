<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>E7</epicId>
    <storyId>1</storyId>
    <title>Implement Finding Correction via Chat</title>
    <status>drafted</status>
    <generatedAt>2025-12-07</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/e7-1-implement-finding-correction-via-chat.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>an M&A analyst</asA>
    <iWant>to correct system-generated findings through the chat interface</iWant>
    <soThat>the knowledge base reflects accurate information</soThat>
    <tasks>
      <task id="1" title="Create Database Migrations" acs="#3, #11, #12">
        <subtask id="1.1">Create migration 00028_create_finding_corrections_table.sql with source validation fields</subtask>
        <subtask id="1.2">Create migration 00032_add_needs_review_to_findings.sql for needs_review column</subtask>
        <subtask id="1.3">Create migration 00033_add_document_reliability_tracking.sql for reliability_status</subtask>
        <subtask id="1.4">Create migration 00034_create_feature_flags_table.sql for safe rollout</subtask>
        <subtask id="1.5">Apply migrations and regenerate Supabase types</subtask>
        <subtask id="1.6">Write unit tests for migration verification</subtask>
      </task>
      <task id="2" title="Implement Feature Flags Configuration" acs="#12, #13, #14, #15">
        <subtask id="2.1">Create lib/config/feature-flags.ts with LEARNING_FLAGS</subtask>
        <subtask id="2.2">Implement getFeatureFlag() function with database fallback</subtask>
        <subtask id="2.3">Add environment variables to .env.example</subtask>
        <subtask id="2.4">Write unit tests for feature flag logic</subtask>
      </task>
      <task id="3" title="Implement Correction Service" acs="#2, #3, #4, #11">
        <subtask id="3.1">Create lib/services/corrections.ts with FindingCorrection types</subtask>
        <subtask id="3.2">Implement correctFinding() function with transaction handling</subtask>
        <subtask id="3.3">Implement getCorrectionHistory() function</subtask>
        <subtask id="3.4">Implement source citation retrieval (getOriginalSource())</subtask>
        <subtask id="3.5">Write unit tests for correction service (target: 90% coverage)</subtask>
      </task>
      <task id="4" title="Implement Source Error Cascade Service" acs="#12, #13, #14, #15, #16">
        <subtask id="4.1">Create lib/services/source-error-cascade.ts</subtask>
        <subtask id="4.2">Implement markDocumentAsUnreliable() function</subtask>
        <subtask id="4.3">Implement flagAllFindingsFromDocument() function</subtask>
        <subtask id="4.4">Implement regenerateFindingEmbedding() function</subtask>
        <subtask id="4.5">Implement syncToNeo4j() function for graph updates</subtask>
        <subtask id="4.6">Gate all cascade operations behind feature flags</subtask>
        <subtask id="4.7">Write unit tests for cascade service (target: 90% coverage)</subtask>
      </task>
      <task id="5" title="Implement Correction Propagation Service" acs="#5, #6">
        <subtask id="5.1">Create lib/services/correction-propagation.ts</subtask>
        <subtask id="5.2">Implement Neo4j query for BASED_ON relationships</subtask>
        <subtask id="5.3">Implement flagDependentInsights() function</subtask>
        <subtask id="5.4">Implement impact summary generation</subtask>
        <subtask id="5.5">Write unit tests for propagation service (target: 90% coverage)</subtask>
      </task>
      <task id="6" title="Enhance Agent Tools for Corrections" acs="#1, #7, #8, #9, #10">
        <subtask id="6.1">Enhance update_knowledge_base tool with correction flag</subtask>
        <subtask id="6.2">Implement correction intent detection in prompts</subtask>
        <subtask id="6.3">Implement source validation conversation flow</subtask>
        <subtask id="6.4">Handle multiple corrections in single message</subtask>
        <subtask id="6.5">Implement "Show Source" document preview trigger</subtask>
        <subtask id="6.6">Write integration tests for agent correction flow</subtask>
      </task>
      <task id="7" title="Create API Endpoints" acs="#2, #3, #8">
        <subtask id="7.1">Create POST /api/projects/[id]/findings/[findingId]/correct endpoint</subtask>
        <subtask id="7.2">Create GET /api/projects/[id]/findings/[findingId]/source endpoint</subtask>
        <subtask id="7.3">Create GET /api/projects/[id]/findings/[findingId]/history endpoint</subtask>
        <subtask id="7.4">Add Zod validation schemas</subtask>
        <subtask id="7.5">Write API integration tests</subtask>
      </task>
      <task id="8" title="Create TypeScript Types" acs="all">
        <subtask id="8.1">Create lib/types/feedback.ts with correction types</subtask>
        <subtask id="8.2">Add CorrectionWithImpact type with source error cascade fields</subtask>
        <subtask id="8.3">Export types from module index</subtask>
        <subtask id="8.4">Ensure type consistency with database schema</subtask>
      </task>
      <task id="9" title="Testing" acs="all">
        <subtask id="9.1">Write unit tests for all services (corrections, cascade, propagation)</subtask>
        <subtask id="9.2">Write integration tests for agent correction flow</subtask>
        <subtask id="9.3">Write integration tests for API endpoints</subtask>
        <subtask id="9.4">Write integration tests for source error cascade</subtask>
        <subtask id="9.5">Verify all tests pass with npm run test:run</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1">Agent detects correction intent in messages like "The revenue should be $50M, not $45M"</ac>
    <ac id="2">Finding is updated in PostgreSQL findings table with corrected value</ac>
    <ac id="3">Original value stored in finding_corrections table with analyst_id and timestamp</ac>
    <ac id="4">Agent confirms correction with message including original and new values</ac>
    <ac id="5">Related insights are flagged for review (needs_review = true)</ac>
    <ac id="6">Agent reports number of affected dependent items in confirmation</ac>
    <ac id="7">Multiple corrections in single message are all processed</ac>
    <ac id="8">Before accepting correction, agent displays original source document and location</ac>
    <ac id="9">Agent asks user for source/basis of correction (e.g., "management call", "different document")</ac>
    <ac id="10">User can request "Show Source" to view original document context before confirming</ac>
    <ac id="11">Correction record includes validation_status: 'confirmed_with_source', 'override_without_source', or 'source_error'</ac>
    <ac id="12">When validation_status = 'source_error', document is marked with reliability_status = 'contains_errors'</ac>
    <ac id="13">When validation_status = 'source_error', ALL findings from the source document are flagged for review</ac>
    <ac id="14">When validation_status = 'source_error', corrected finding embedding is regenerated in pgvector</ac>
    <ac id="15">When validation_status = 'source_error', Neo4j document node and finding nodes are updated</ac>
    <ac id="16">Agent reports total number of findings flagged from unreliable document in confirmation</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/sprint-artifacts/tech-spec-epic-E7.md" title="Epic 7 Technical Specification" section="Full specification" snippet="Comprehensive tech spec covering Learning Loop architecture, data models, workflows, APIs, and test strategy for E7.1-E7.6 stories." />
      <doc path="docs/sprint-artifacts/epics/epic-E7.md" title="Epic 7 Overview" section="Learning Loop" snippet="Epic overview defining stories E7.1-E7.6, feature flag strategy, and database table requirements." />
      <doc path="docs/manda-prd.md" title="Product Requirements Document" section="5.7 Learning Loop" snippet="FR-LEARN-001 through FR-LEARN-004 defining finding corrections, confidence score learning, response improvement, and feedback incorporation." />
      <doc path="docs/agent-behavior-spec.md" title="Agent Behavior Specification" section="P1-P8 Prerequisites" snippet="Hybrid search architecture, agent behavior framework, and expected behaviors for different use cases. Defines correction chain detection patterns." />
      <doc path="docs/manda-architecture.md" title="System Architecture" section="Data Layer" snippet="PostgreSQL with pgvector for embeddings, Neo4j for knowledge graph relationships, Supabase for auth and real-time." />
    </docs>
    <code>
      <file path="lib/agent/tools/knowledge-tools.ts" kind="service" symbol="updateKnowledgeBaseTool" lines="181-262" reason="Primary tool to enhance for correction flag support. Contains existing update_knowledge_base implementation." />
      <file path="lib/agent/tools/knowledge-tools.ts" kind="service" symbol="validateFindingTool" lines="264-383" reason="Existing validation tool to reference for patterns. May need BASED_ON relationship integration." />
      <file path="lib/agent/tools/knowledge-tools.ts" kind="service" symbol="updateKnowledgeGraphTool" lines="385-591" reason="Neo4j relationship creation patterns. Reference for SUPERSEDES relationship implementation." />
      <file path="lib/services/embeddings.ts" kind="service" symbol="generateEmbedding" lines="95-159" reason="Embedding generation for corrected findings (AC #14). Uses OpenAI text-embedding-3-large." />
      <file path="lib/neo4j/operations.ts" kind="service" symbol="createRelationship" lines="109-126" reason="Neo4j relationship creation. Use for BASED_ON relationship queries for dependent insights." />
      <file path="lib/neo4j/operations.ts" kind="service" symbol="updateNode" lines="57-66" reason="Neo4j node update patterns for document and finding node updates (AC #15)." />
      <file path="lib/neo4j/operations.ts" kind="service" symbol="getRelatedNodes" lines="156-181" reason="Query related nodes by relationship type. Use for BASED_ON traversal." />
      <file path="lib/types/findings.ts" kind="types" symbol="Finding, ValidationEvent" lines="1-214" reason="Existing finding types. Need to extend with needs_review, correction fields." />
      <file path="app/api/projects/[id]/findings/[findingId]/validate/route.ts" kind="api" symbol="POST handler" lines="1-162" reason="Reference for finding update API pattern with validation history." />
      <file path="lib/api/findings.ts" kind="client" symbol="findingsApi" reason="Client-side API functions for findings. Add correction-related functions here." />
      <file path="lib/supabase/database.types.ts" kind="types" symbol="Database" reason="Generated Supabase types. Will need regeneration after migrations." />
      <file path="__tests__/utils/supabase-mock.ts" kind="test-util" symbol="createMockSupabaseClient" reason="Shared Supabase mock utilities for unit tests." />
    </code>
    <dependencies>
      <node>
        <package name="@supabase/supabase-js" version="^2.84.0" />
        <package name="neo4j-driver" version="^6.0.1" />
        <package name="openai" version="^6.9.1" />
        <package name="@langchain/core" version="^1.1.0" />
        <package name="zod" version="^4.1.13" />
        <package name="sonner" version="^2.0.7" />
        <package name="date-fns" version="^4.1.0" />
        <package name="pg-boss" version="^12.3.1" />
      </node>
      <devDependencies>
        <package name="vitest" version="^4.0.14" />
        <package name="@testing-library/react" version="^16.3.0" />
        <package name="@playwright/test" version="^1.57.0" />
      </devDependencies>
      <newRequired>
        <package name="diff" version="^7.0.0" purpose="Text diff for detecting correction changes (E7.3, can add now)" />
      </newRequired>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Append-only audit trail: finding_corrections table has no UPDATE/DELETE RLS policies to ensure compliance and full correction history</constraint>
    <constraint type="architecture">Transaction pattern: Correction insert + findings update must be wrapped in a single transaction to ensure atomicity</constraint>
    <constraint type="architecture">Feature flag gating: Source error cascade operations are gated behind LEARNING_SOURCE_ERROR_CASCADE_ENABLED (OFF by default) for safe rollout</constraint>
    <constraint type="architecture">Neo4j async fallback: If Neo4j is unavailable, PostgreSQL updates proceed; Neo4j sync is retried via pg-boss</constraint>
    <constraint type="pattern">Services go in lib/services/ following existing patterns (embeddings.ts, irls.ts)</constraint>
    <constraint type="pattern">API routes follow Next.js 15 app router conventions at app/api/projects/[id]/</constraint>
    <constraint type="pattern">Feature flags configuration in lib/config/</constraint>
    <constraint type="pattern">Types in lib/types/feedback.ts (new file)</constraint>
    <constraint type="pattern">Agent tool enhancements in lib/agent/tools/knowledge-tools.ts</constraint>
    <constraint type="testing">Use existing Supabase mock utilities from __tests__/utils/supabase-mock.ts</constraint>
    <constraint type="testing">Mock Neo4j for graph query tests</constraint>
    <constraint type="testing">Target 90% coverage for service modules</constraint>
  </constraints>

  <interfaces>
    <interface name="POST /api/projects/[id]/findings/[findingId]/correct" kind="REST endpoint" signature="{ correctedValue: string, correctionType: 'value' | 'source' | 'confidence' | 'text', reason?: string, userSourceReference?: string, validationStatus: 'confirmed_with_source' | 'override_without_source' | 'source_error' } => CorrectionWithImpact" path="app/api/projects/[id]/findings/[findingId]/correct/route.ts" />
    <interface name="GET /api/projects/[id]/findings/[findingId]/source" kind="REST endpoint" signature="() => { sourceDocument: string, sourceLocation: string, extractedValue: string }" path="app/api/projects/[id]/findings/[findingId]/source/route.ts" />
    <interface name="GET /api/projects/[id]/findings/[findingId]/history" kind="REST endpoint" signature="() => FindingCorrection[]" path="app/api/projects/[id]/findings/[findingId]/history/route.ts" />
    <interface name="correctFinding" kind="service function" signature="(findingId: string, correction: CorrectionInput, analystId: string) => Promise&lt;CorrectionWithImpact&gt;" path="lib/services/corrections.ts" />
    <interface name="getOriginalSource" kind="service function" signature="(findingId: string) => Promise&lt;{ sourceDocument: string, sourceLocation: string, extractedValue: string } | null&gt;" path="lib/services/corrections.ts" />
    <interface name="markDocumentAsUnreliable" kind="service function" signature="(documentId: string, notes: string) => Promise&lt;void&gt;" path="lib/services/source-error-cascade.ts" />
    <interface name="flagAllFindingsFromDocument" kind="service function" signature="(documentId: string, reason: string) => Promise&lt;number&gt;" path="lib/services/source-error-cascade.ts" />
    <interface name="regenerateFindingEmbedding" kind="service function" signature="(findingId: string, correctedText: string) => Promise&lt;void&gt;" path="lib/services/source-error-cascade.ts" />
    <interface name="flagDependentInsights" kind="service function" signature="(findingId: string) => Promise&lt;DependentInsight[]&gt;" path="lib/services/correction-propagation.ts" />
    <interface name="getFeatureFlag" kind="config function" signature="(flag: keyof typeof LEARNING_FLAGS) => Promise&lt;boolean&gt;" path="lib/config/feature-flags.ts" />
  </interfaces>

  <tests>
    <standards>
      <framework>Vitest for unit tests, Playwright for E2E tests</framework>
      <pattern>Use shared Supabase mock utilities from __tests__/utils/supabase-mock.ts</pattern>
      <pattern>Mock Neo4j operations using vi.mock for graph query tests</pattern>
      <coverage>Target 90% coverage for service modules (corrections.ts, source-error-cascade.ts, correction-propagation.ts)</coverage>
      <pattern>Follow component testing patterns established in E4-E6</pattern>
      <command>npm run test:run to verify all tests pass</command>
    </standards>
    <locations>
      <location pattern="__tests__/services/corrections.test.ts" />
      <location pattern="__tests__/services/source-error-cascade.test.ts" />
      <location pattern="__tests__/services/correction-propagation.test.ts" />
      <location pattern="__tests__/api/findings/correct.test.ts" />
      <location pattern="__tests__/api/findings/source.test.ts" />
      <location pattern="__tests__/api/findings/history.test.ts" />
      <location pattern="__tests__/agent/correction-flow.test.ts" />
      <location pattern="__tests__/config/feature-flags.test.ts" />
    </locations>
    <ideas>
      <idea ac="1">Test correction intent detection with various phrasings: "should be", "is actually", "correct to", "change from X to Y"</idea>
      <idea ac="2">Test finding update with corrected value, verify old value unchanged in corrections table</idea>
      <idea ac="3">Test correction record creation with all required fields: analyst_id, timestamp, original_value</idea>
      <idea ac="4">Test agent confirmation message format includes both original and new values</idea>
      <idea ac="5">Test Neo4j BASED_ON traversal flags dependent insights with needs_review = true</idea>
      <idea ac="6">Test impact count returned in response matches actual flagged items</idea>
      <idea ac="7">Test batch correction parsing: "A should be X, and B should be Y"</idea>
      <idea ac="8">Test source citation display before confirmation with document name and location</idea>
      <idea ac="9">Test user source reference options: "management call", "different document", override</idea>
      <idea ac="10">Test "Show Source" triggers document preview modal</idea>
      <idea ac="11">Test all three validation_status values are correctly stored</idea>
      <idea ac="12">Test source_error triggers document reliability_status update when flag enabled</idea>
      <idea ac="13">Test all sibling findings flagged when source_error and flag enabled</idea>
      <idea ac="14">Test embedding regeneration called with corrected text when flag enabled</idea>
      <idea ac="15">Test Neo4j document and finding nodes updated when flag enabled</idea>
      <idea ac="16">Test agent reports correct count of flagged findings from unreliable document</idea>
      <idea general="feature-flags">Test feature flag OFF disables cascade operations</idea>
      <idea general="transaction">Test transaction rollback on partial failure</idea>
      <idea general="neo4j-fallback">Test Neo4j unavailable doesn't block PostgreSQL updates</idea>
    </ideas>
  </tests>
</story-context>