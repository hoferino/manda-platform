# Sprint Status - Manda Platform Implementation
# Generated: 2025-11-28
# Last Updated: 2025-11-28
# Project: Manda
# Tracking System: file-system
# Story Location: docs/sprint-artifacts

# ===================
# BUSINESS PRINCIPLES
# ===================
# Core principles that guide sprint planning and execution
principles:
  - id: BP-001
    title: Zero Technical Debt Policy
    established: 2025-11-28
    description: |
      We do not carry unnecessary technical debt between sprints.
      All identified tech debt items must be addressed before starting new feature epics.
      Rationale: Accumulated debt slows velocity, increases bug risk, and compounds over time.
      Implementation:
      - Backlog items from retrospectives are resolved in dedicated tech debt sprints
      - New epics cannot begin until backlog is clear or explicitly deferred with justification
      - Code review includes tech debt assessment

# ===================
# TECH DEBT SPRINT
# ===================
# Sprint dedicated to resolving backlog items before Epic 4
tech_debt_sprint:
  name: "Tech Debt Resolution Sprint"
  started: 2025-11-28
  completed: 2025-11-28
  target_completion: 2025-11-29
  status: done
  goal: Clear all medium/high priority backlog items before Epic 4
  retrospective: docs/sprint-artifacts/retrospectives/tech-debt-sprint-retrospective.md
  summary: |
    All 3 stories completed in single session. TD-002 (rate limiting) deferred per BP-001.
    Key deliverables:
    - Playwright E2E testing infrastructure with 15 Data Room tests
    - Vitest parallel execution with 3-way CI sharding (41s → ~3s/shard)
    - Shared Supabase test utilities reducing test boilerplate
    - CI pipeline with lint, unit tests (sharded), E2E tests, and build stages
  stories:
    - id: TD-001
      backlog_ref: BL-001
      title: Add E2E tests for Data Room
      status: done
      priority: medium
      estimate: 4h
      completed: 2025-11-28
      scope: |
        - Set up Playwright in manda-app
        - Write E2E tests for document upload flow
        - Write E2E tests for folder/bucket operations
        - Add to CI pipeline
      deliverables: |
        - playwright.config.ts - Playwright configuration with Chromium
        - e2e/auth.setup.ts - Authentication setup for E2E tests
        - e2e/data-room.spec.ts - Comprehensive E2E tests for Data Room:
          * Folder operations: create, rename, delete, breadcrumb navigation
          * Document upload: single file, folder upload, progress tracking
          * View toggle: Folders/Buckets views with preference persistence
          * Drag and drop: move documents to folders
          * Processing status: display and realtime connection
        - .github/workflows/ci.yml - CI pipeline with unit tests, E2E tests, and build
        - Added data-testid attributes to key components for reliable test selection
        - npm scripts: test:e2e, test:e2e:ui, test:e2e:headed, test:e2e:report

    - id: TD-003
      backlog_ref: BL-004
      title: Implement test sharding / parallel execution
      status: done
      priority: medium
      estimate: 2h
      completed: 2025-11-28
      scope: |
        - Configure Vitest for parallel test execution
        - Set up test sharding for CI (split by file)
        - Target: <60s full test run
      deliverables: |
        - vitest.config.ts: Updated with thread pool parallelization
          * pool: 'threads' for multi-core execution
          * Test isolation for reliability
          * CI-optimized reporters (dot + JSON)
        - .github/workflows/ci.yml: Updated with 3-way test sharding
          * Tests split across 3 parallel runners
          * Each shard ~3s instead of 41s total
          * fail-fast: false for complete results
        - Performance improvement:
          * Full run: 41s (local)
          * Per shard: ~3s (CI will run 3 in parallel)

    - id: TD-004
      backlog_ref: BL-005
      title: Create shared Supabase test utilities
      status: done
      priority: medium
      estimate: 2h
      completed: 2025-11-28
      scope: |
        - Create __tests__/utils/supabase-mock.ts
        - Standardize mock patterns across components
        - Refactor existing tests to use shared utilities
      deliverables: |
        - __tests__/utils/supabase-mock.ts: Comprehensive Supabase test utilities
          * MockQueryBuilder interface with chainable methods (from, select, eq, order, etc.)
          * MockSupabaseAuth interface (getUser, getSession, signIn, signOut, onAuthStateChange)
          * MockSupabaseClient interface combining query builder, auth, and realtime
          * createMockSupabaseClient() - returns client + individual mock references
          * mockSupabaseModule() - for vi.mock('@/lib/supabase/client')
          * mockSupabaseServerModule() - for server-side Supabase mocking
          * Data factories: createMockUser, createMockDocument, createMockProject, createMockFolder
          * Helper functions: mockQuerySuccess, mockQueryError, mockAuthenticatedUser, mockUnauthenticated
        - Refactored buckets-view-integration.test.tsx to use shared utilities
          * Replaced inline mock with createMockSupabaseClient()
          * Uses createMockDocument/createMockFolder data factories
          * All 4 tests passing

# Deferred items (low priority - will address in future sprints)
deferred_backlog:
  - id: BL-002
    title: Add rate limiting on document endpoints
    priority: medium
    defer_reason: Could block power users during heavy due diligence. Revisit before production launch.

  - id: BL-003
    title: Monitor GCS costs as usage grows
    priority: low
    defer_reason: No production traffic yet, will address before launch

  - id: BL-006
    title: Error message consistency catalog
    priority: low
    defer_reason: Nice-to-have, can address incrementally

  - id: BL-007
    title: Pipeline visualization tool
    priority: low
    defer_reason: Current logging sufficient for MVP debugging

# ===================
# BACKLOG ITEMS
# ===================
# Technical debt and action items from retrospectives
backlog:
  # From Epic 2 Retrospective (2025-11-26)
  - id: BL-001
    title: Add E2E tests for Data Room
    priority: medium
    source: epic-2-retrospective
    description: |
      No Playwright/Cypress E2E tests were created during Epic 2.
      Manual verification worked but doesn't scale.
      Consider adding E2E test story or including in DoD.

  - id: BL-002
    title: Add rate limiting on document endpoints
    priority: medium
    source: epic-2-retrospective
    description: |
      Document upload and download endpoints lack rate limiting.
      Required for production readiness to prevent abuse.
      Consider using middleware or API gateway.

  - id: BL-003
    title: Monitor GCS costs as usage grows
    priority: low
    source: epic-2-retrospective
    description: |
      Google Cloud Storage costs should be monitored as document volume increases.
      Set up billing alerts and consider lifecycle policies for old documents.

  # From Epic 3 Retrospective (2025-11-28)
  - id: BL-004
    title: Test sharding / parallel execution
    priority: medium
    source: epic-3-retrospective
    description: |
      550+ tests causing slower CI runs.
      Implement test sharding or parallel execution.

  - id: BL-005
    title: Shared Supabase test utilities
    priority: medium
    source: epic-3-retrospective
    description: |
      Mocking Supabase client required repetitive setup across tests.
      Create shared test utilities for consistency.

  - id: BL-006
    title: Error message consistency catalog
    priority: low
    source: epic-3-retrospective
    description: |
      Some error messages are technical, others user-friendly.
      Create catalog for consistency (potential i18n foundation).

  - id: BL-007
    title: Pipeline visualization tool
    priority: low
    source: epic-3-retrospective
    description: |
      5-stage pipeline is complex to debug.
      Consider enhanced logging or visualization tool.

# generated: 2025-11-28
# project: Manda
# project_key: manda-platform
# tracking_system: file-system
# story_location: docs/sprint-artifacts

# STATUS DEFINITIONS:
# ==================
# Epic Status:
#   - backlog: Epic exists in epic file but not contexted
#   - contexted: Epic tech context created (required before drafting stories)
#   - done: All stories in epic completed
#
# Story Status:
#   - backlog: Story only exists in epic file
#   - drafted: Story file created in stories folder
#   - ready-for-dev: Draft approved and story context created
#   - in-progress: Developer actively working on implementation
#   - review: Under SM review (via code-review workflow)
#   - done: Story completed
#
# Retrospective Status:
#   - optional: Can be completed but not required
#   - completed: Retrospective has been done
#
# WORKFLOW NOTES:
# ===============
# - Epics should be 'contexted' before stories can be 'drafted'
# - Stories can be worked in parallel if team capacity allows
# - SM typically drafts next story after previous one is 'done' to incorporate learnings
# - Dev moves story to 'review', SM reviews, then Dev moves to 'done'

generated: 2025-11-28
project: Manda
project_key: manda-platform
tracking_system: file-system
story_location: docs/sprint-artifacts

development_status:
  # Epic 1: Project Foundation (9 stories) - COMPLETED 2025-11-25
  epic-1: done
  epic-1-jira-id: SCRUM-10
  epic-1-completed: 2025-11-25
  epic-1-notes: |
    All 9 stories completed. Key deliverables:
    - Next.js 15 with shadcn/ui, Tailwind CSS, TypeScript
    - Supabase Auth with SSR middleware, protected routes
    - PostgreSQL schema with RLS policies for multi-tenant isolation
    - Projects overview with search, filter, and pagination
    - 2-step project creation wizard (simplified from 3-step)
    - Project workspace shell with sidebar navigation
    - Neo4j graph database integration
    - pg-boss job queue with health monitoring
    - Audit logging for security events
    Architecture decisions:
    - Document storage: Google Cloud Storage (GCS) - decided for Epic 2
    - Test infrastructure: Vitest + React Testing Library (19 tests)
    - Error boundaries: Hierarchical error handling with recovery
  e1-1-set-up-nextjs-15-project-with-shadcnui: done
  e1-1-jira-id: SCRUM-11
  e1-2-configure-supabase-auth-and-database-connection: done
  e1-2-jira-id: SCRUM-12
  e1-3-create-postgresql-schema-with-rls-policies: done
  e1-3-jira-id: SCRUM-13
  e1-4-build-projects-overview-screen-landing: done
  e1-4-jira-id: SCRUM-14
  e1-5-implement-project-creation-wizard: done
  e1-5-jira-id: SCRUM-15
  e1-6-build-project-workspace-shell-with-navigation: done
  e1-6-jira-id: SCRUM-16
  e1-7-configure-neo4j-graph-database: done
  e1-7-jira-id: SCRUM-17
  e1-8-configure-pg-boss-job-queue: done
  e1-8-jira-id: SCRUM-18
  e1-9-implement-audit-logging-for-security-events: done
  e1-9-jira-id: SCRUM-19
  epic-1-retrospective: completed

  # Epic 2: Document Ingestion & Storage (8 stories) - COMPLETED 2025-11-26
  # Uses GCS (architecture decision 2025-11-25)
  # COURSE CORRECTION v2.6 (2025-11-26):
  # - Unified bucket/folder model: folder_path is single source of truth
  # - Buckets = top-level folders (same data, different view)
  # - Removed deal_type from wizard (didn't drive behavior)
  # - Empty projects have empty data rooms (no default buckets)
  # - Removed category column from documents table
  # COURSE CORRECTION v2.7 (2025-11-28):
  # - Persistent folder storage with folders table
  # - Bug fixes: Buckets tab click, New Bucket button
  epic-2: done
  epic-2-jira-id: SCRUM-21
  epic-2-completed: 2025-11-26
  e2-1-implement-document-upload-to-google-cloud-storage: done
  e2-1-jira-id: SCRUM-22
  e2-1-completed: 2025-11-25
  e2-2-build-data-room-folder-structure-view: done
  e2-2-completed: 2025-11-25
  e2-2-jira-id: SCRUM-23
  e2-3-build-data-room-buckets-view-category-based: done
  e2-3-completed: 2025-11-25
  e2-3-jira-id: SCRUM-24
  e2-3-refactored: 2025-11-26  # v2.6: Refactored to derive buckets from folder_path, removed hardcoded categories
  e2-4-implement-view-toggle-and-user-preference: done
  e2-4-jira-id: SCRUM-25
  e2-4-completed: 2025-11-26
  e2-5-create-document-metadata-management: done
  e2-5-jira-id: SCRUM-26
  e2-5-completed: 2025-11-26
  e2-6-implement-document-actions-view-download-delete: done
  e2-6-jira-id: SCRUM-27
  e2-6-completed: 2025-11-26
  e2-6-reviewed: 2025-11-26
  e2-7-build-upload-progress-indicators-and-websocket-updates: done
  e2-7-jira-id: SCRUM-28
  e2-7-completed: 2025-11-26
  e2-8-implement-irl-integration-with-document-tracking: done
  e2-8-jira-id: SCRUM-29
  e2-8-completed: 2025-11-26
  epic-2-retrospective: completed
  epic-2-notes: |
    All 8 stories completed. Key deliverables:
    - Google Cloud Storage integration with signed URLs
    - Data Room with Folder and Bucket views (unified model)
    - Virtual folders derived from folder_path (no separate table)
    - Drag-and-drop document management
    - Upload progress with Zustand store and parallel uploads
    - IRL Checklist panel for document tracking
    - 135 tests (7x growth from Epic 1)
    Architecture decisions:
    - Buckets = top-level folders (v2.6 course correction)
    - XHR for upload progress (Fetch API limitation)
    - Zustand + localStorage for upload persistence

  # Epic 3: Intelligent Document Processing (9 stories) - COMPLETED 2025-11-28
  # CONTEXTED: 2025-11-26
  # Tech Spec: docs/sprint-artifacts/tech-spec-epic-E3.md
  # Key Decisions:
  # - FastAPI Python backend (manda-processing service)
  # - Tiered Gemini 2.5: Flash (extraction), Pro (deep analysis), Flash-Lite (batch)
  # - pgvector for embeddings (staying with Supabase for MVP)
  # - Docling for document parsing with OCR
  # - 3 new tables: document_chunks, findings, financial_metrics
  epic-3: done
  epic-3-jira-id: SCRUM-30
  epic-3-contexted: 2025-11-26
  epic-3-completed: 2025-11-28
  epic-3-tech-spec: docs/sprint-artifacts/tech-spec-epic-E3.md
  e3-1-set-up-fastapi-backend-with-pg-boss-job-queue: done
  e3-1-jira-id: SCRUM-31
  e3-1-drafted: 2025-11-26
  e3-1-context-ready: 2025-11-26
  e3-1-completed: 2025-11-26
  e3-1-reviewed: 2025-11-26
  e3-1-notes: |
    FastAPI backend created with pg-boss job queue integration.
    79 tests passing with 93% coverage. Python 3.12+ required.
    Direct SQL approach for pg-boss compatibility with TypeScript.
    Code review APPROVED - all 6 ACs verified, no HIGH/MEDIUM issues.
  e3-2-integrate-docling-for-document-parsing: done
  e3-2-jira-id: SCRUM-32
  e3-2-drafted: 2025-11-26
  e3-2-completed: 2025-11-26
  e3-2-reviewed: 2025-11-26
  e3-2-notes: |
    Docling integration completed with comprehensive parser module.
    136 tests passing (24 skipped for docling-dependent tests).
    Coverage: chunker.py 87%, excel_parser.py 89%, __init__.py 96%.
    Code review APPROVED - all 6 ACs verified, no HIGH/MEDIUM blocking issues.
    Key deliverables:
    - Parser interface with Pydantic models (ChunkData, TableData, FormulaData, ParseResult)
    - Excel parser with formula preservation (openpyxl)
    - PDF parser with OCR support (Docling)
    - Semantic chunking (512-1024 tokens, tiktoken)
    - Documentation at manda-processing/docs/parsers.md
  e3-3-implement-document-parsing-job-handler: done
  e3-3-jira-id: SCRUM-33
  e3-3-drafted: 2025-11-26
  e3-3-completed: 2025-11-27
  e3-3-notes: |
    Document parsing job handler completed. Key deliverables:
    - ParseDocumentHandler class with GCS download, parsing, DB storage
    - Webhook endpoint for triggering parse jobs (/webhooks/document-uploaded)
    - Atomic transaction: store chunks + update status in single transaction
    - Error handling: GCS errors, parse errors, DB errors with retry classification
    - 137 tests passing with 84% coverage on new code
    Key files:
    - src/jobs/handlers/parse_document.py - Main handler
    - src/storage/gcs_client.py - GCS download with retry
    - src/storage/supabase_client.py - DB operations for chunks
    - src/api/routes/webhooks.py - Webhook endpoints
    - migrations/00015_create_document_chunks_table.sql - Chunks table
  e3-4-generate-embeddings-for-semantic-search: done
  e3-4-jira-id: SCRUM-34
  e3-4-drafted: 2025-11-27
  e3-4-context-ready: 2025-11-27
  e3-4-completed: 2025-11-27
  e3-4-notes: |
    Embedding generation completed. Key deliverables:
    - OpenAI embedding client with text-embedding-3-large (3072 dims)
    - Batch processing with retry logic and token tracking
    - generate_embeddings job handler with pipeline integration
    - Similarity search API: GET /api/search/similar
    - 37 tests passing with 86% coverage
    Key files:
    - src/embeddings/openai_client.py - OpenAI embedding client
    - src/jobs/handlers/generate_embeddings.py - Job handler
    - src/api/routes/search.py - Similarity search API
    - migrations/00016_update_embedding_dimension.sql - Vector dimensions
  e3-5-implement-llm-analysis-with-gemini-25-tiered: done
  e3-5-jira-id: SCRUM-35
  e3-5-drafted: 2025-11-27
  e3-5-context-ready: 2025-11-27
  e3-5-completed: 2025-11-27
  e3-5-reviewed: 2025-11-27
  e3-5-notes: |
    LLM analysis with Gemini 2.5 tiered models completed. Key deliverables:
    - GeminiClient with LangChain integration and tiered model support (Flash/Pro/Lite)
    - Model selection based on document type (Pro for Excel, Flash default)
    - M&A-specific finding extraction prompts with structured output
    - analyze_document job handler with atomic findings storage
    - 62 tests passing
    Code review APPROVED - all 6 ACs verified, no issues found.
    Key files:
    - src/llm/client.py - GeminiClient with retry logic
    - src/llm/models.py - ModelTier enum and selection
    - src/llm/prompts.py - M&A extraction prompts
    - src/models/findings.py - Finding Pydantic models
    - src/jobs/handlers/analyze_document.py - Job handler
    - migrations/00017_update_findings_for_llm_analysis.sql - Schema update
  e3-6-create-processing-status-tracking-and-websocket-updates: done
  e3-6-jira-id: SCRUM-36
  e3-6-drafted: 2025-11-27
  e3-6-context-ready: 2025-11-27
  e3-6-completed: 2025-11-27
  e3-6-notes: |
    Processing status tracking and WebSocket updates completed. Key deliverables:
    - ProcessingStatusBadge component with all granular statuses
    - ProcessingProgress component showing pipeline stages
    - useDocumentUpdates Supabase Realtime hook
    - Real-time connection status indicator in Data Room
    - Toast notifications for completion/failure
    - Enhanced DocumentDetails panel with retry button
    - /api/documents/[id]/retry API route
    - 207 tests passing
  e3-7-implement-processing-queue-visibility: done
  e3-7-drafted: 2025-11-27
  e3-7-context-ready: 2025-11-27
  e3-7-completed: 2025-11-27
  e3-7-jira-id: SCRUM-37
  e3-7-notes: |
    Processing queue visibility implemented. Key deliverables:
    - FastAPI endpoints: GET /api/processing/queue, DELETE /api/processing/queue/{job_id}
    - Next.js proxy routes for queue operations
    - ProcessingQueue collapsible panel component with real-time updates
    - QueueItem component with cancel/retry actions
    - useProcessingQueue hook with polling
    - Integrated into Data Room above document list
    - Tests for components, hooks, and API endpoints
  e3-8-implement-retry-logic-for-failed-processing: done
  e3-8-drafted: 2025-11-27
  e3-8-context-ready: 2025-11-27
  e3-8-completed: 2025-11-27
  e3-8-jira-id: SCRUM-38
  e3-8-notes: |
    Retry logic for failed processing completed. Key deliverables:
    - ErrorClassifier with transient/permanent error classification
    - ProcessingStage enum for stage-aware retry (parsing → embedding → analyzing)
    - RetryManager with stage tracking, retry history, and rate limiting
    - Manual retry controls: 60s cooldown, 5 total attempts max
    - Stage-aware retry endpoints: /api/processing/retry/embedding, /api/processing/retry/analysis
    - Enhanced UI: structured error display, retry history collapsible, stage-aware retry button
    - 139 tests passing (95 error + 44 retry manager)
    Code review fixes applied:
    - Pattern priority in ErrorClassifier (specific before generic)
    - Error handling in enqueue_stage_retry (prevent inconsistent state)
    - Manual retry rate limiting and total attempt cap
  e3-9-financial-model-integration-extract-and-query-financial-metrics: done
  e3-9-jira-id: SCRUM-39
  e3-9-drafted: 2025-11-27
  e3-9-completed: 2025-11-27
  e3-9-reviewed: 2025-11-27
  e3-9-notes: |
    Financial model integration completed. Key deliverables:
    - Database schema with financial_metrics table and RLS policies
    - FinancialDocumentDetector with EN+DE pattern matching (30.0 confidence threshold)
    - FinancialMetricExtractor parsing tables, values, periods, and formulas
    - extract_financials job handler with retry integration
    - API endpoints for querying metrics by project/document/category
    - 82 tests passing with 87% coverage
    Code review approved: Fixed PDF table financial extraction trigger
  epic-3-retrospective: completed
  epic-3-retrospective-completed: 2025-11-28
  epic-3-notes: |
    All 9 stories completed. Duration: 3 days (Nov 26-28).
    Key deliverables:
    - FastAPI Python backend (manda-processing service)
    - Document parsing with Docling (PDF, Word, Excel)
    - Embeddings with OpenAI text-embedding-3-large (3072 dims)
    - LLM analysis with tiered Gemini 2.5 (Flash/Pro/Lite)
    - Financial metric extraction (EN+DE patterns)
    - Real-time processing status via Supabase Realtime
    - Processing queue visibility with cancel/retry
    - Stage-aware retry logic with error classification
    - 550+ tests with 85-93% backend coverage
    Key patterns established:
    - Job handler pattern with error classification
    - Supabase Realtime subscription hook
    - Stage-aware processing pipeline

  # Epic 4: Collaborative Knowledge Workflow (13 stories - was 14, E4.11 duplicate removed)
  # CONTEXTED: 2025-11-28
  # Tech Spec: docs/sprint-artifacts/tech-spec-epic-E4.md
  # Key Decisions:
  # - Knowledge Explorer as analyst's primary workspace
  # - Findings Browser with table/card views, semantic search
  # - Contradiction detection via Neo4j CONTRADICTS relationships
  # - Gap analysis against IRL requirements
  # - New tables: contradictions (findings already exists)
  # - Dependencies: @tanstack/react-table, exceljs, csv-stringify
  epic-4: done
  epic-4-jira-id: SCRUM-47
  epic-4-contexted: 2025-11-28
  epic-4-completed: 2025-11-30
  epic-4-tech-spec: docs/sprint-artifacts/tech-spec-epic-E4.md
  epic-4-notes: |
    All 13 stories completed. Duration: 3 days (Nov 28-30).
    Key deliverables:
    - Knowledge Explorer with Findings, Contradictions, Gap Analysis tabs
    - Findings Browser with table/card views, semantic search, source attribution
    - Real-time updates via Supabase Realtime WebSocket subscriptions
    - Contradiction detection with Neo4j integration
    - Gap analysis against IRL requirements
    - Export to CSV, Excel, and HTML report formats
    - Bulk actions for finding management
    - 1000+ tests with comprehensive coverage
    Key patterns established:
    - Supabase Realtime subscription hooks
    - Composite hooks for state management
    - URL state for filter/view persistence
    - Virtual scrolling for large datasets
  e4-1-build-knowledge-explorer-ui-main-interface: done
  e4-1-jira-id: SCRUM-48
  e4-1-drafted: 2025-11-28
  e4-1-context-ready: 2025-11-28
  e4-1-completed: 2025-11-28
  e4-1-notes: |
    Knowledge Explorer UI main interface completed. Key deliverables:
    - Database migration 00021: Added status and validation_history columns to findings
    - API route /api/projects/[id]/findings with GET/POST, Zod validation, pagination
    - TypeScript types in lib/types/findings.ts with helper functions
    - Client service in lib/api/findings.ts for data fetching
    - Knowledge Explorer page with tab navigation (Findings, Contradictions, Gap Analysis)
    - FindingsBrowser with @tanstack/react-table DataTable
    - Filter controls: document, domain, confidence range, status filters
    - Shared badge components: ConfidenceBadge, DomainTag, StatusBadge
    - 22 component tests for FindingsTable (rendering, pagination, sorting, actions, accessibility)
    - Build passing with no TypeScript errors
  e4-2-implement-semantic-search-for-findings: done
  e4-2-drafted: 2025-11-28
  e4-2-jira-id: SCRUM-49
  e4-2-completed: 2025-11-28
  e4-2-reviewed: 2025-11-28
  e4-2-notes: |
    Semantic search for findings completed and reviewed. Key deliverables:
    - Embedding service (lib/services/embeddings.ts) with OpenAI text-embedding-3-large
    - LRU cache for query embeddings with retry logic
    - Database migration 00022: Updated findings.embedding to vector(3072), created HNSW index
    - match_findings RPC function for pgvector cosine similarity search with filters
    - Search API endpoint POST /api/projects/[id]/findings/search
    - FindingSearch component with debounced input (300ms), Enter/Escape keys
    - FindingsBrowser integration with URL state (?q= parameter)
    - SimilarityBadge component for search results
    - 37 tests (14 embedding service + 23 FindingSearch component)
    - Build passing, all story tests passing
    - Migration 00022 applied, Supabase types regenerated
    - Type assertion removed after types regenerated
  e4-3-implement-inline-finding-validation: done
  e4-3-drafted: 2025-11-28
  e4-3-context-ready: 2025-11-28
  e4-3-completed: 2025-11-28
  e4-3-jira-id: SCRUM-50
  e4-3-notes: |
    Inline finding validation completed. Key deliverables:
    - Validate API endpoint POST /api/projects/[id]/findings/[findingId]/validate
    - PATCH API endpoint for editing findings text/status
    - FindingActions component with validate/reject/edit buttons
    - InlineEdit component with keyboard shortcuts (Enter save, Escape cancel)
    - useUndoValidation hook with 5-second undo window
    - Integration with FindingsBrowser and optimistic UI updates
    - Toast notifications with undo action
    - 56 tests passing (FindingActions, InlineEdit, useUndoValidation, validate API)
  e4-4-build-card-view-alternative-for-findings: done
  e4-4-jira-id: SCRUM-51
  e4-4-drafted: 2025-11-29
  e4-4-context-ready: 2025-11-29
  e4-4-completed: 2025-11-30
  e4-4-notes: |
    Card view alternative for findings completed. Key deliverables:
    - FindingCard component with domain/confidence/status badges, text truncation, expand/collapse
    - ViewToggle component with localStorage persistence and keyboard shortcut (Ctrl/Cmd+Shift+V)
    - FindingsCardGrid with responsive grid (1/2/3 cols), virtual scrolling for >100 items
    - Integration with FindingsBrowser - conditional table/card rendering
    - All validation/edit actions work in both views
    - Search mode shows similarity badges on cards
    - @tanstack/react-virtual added for performance optimization
    - 69 tests passing (FindingCard, ViewToggle, FindingsCardGrid)
  e4-5-implement-source-attribution-links: done
  e4-5-jira-id: SCRUM-52
  e4-5-drafted: 2025-11-30
  e4-5-context-ready: 2025-11-30
  e4-5-completed: 2025-11-30
  e4-5-notes: |
    Source attribution links completed. Key deliverables:
    - SourceAttributionLink component with monospace formatted text (doc.xlsx, Sheet 'P&L', Cell B15)
    - DocumentPreviewModal with loading/error states and keyboard dismiss (Escape)
    - ExcelPreview component with cell grid and referenced cell highlighting
    - PdfPreview component with page content and context navigation
    - FallbackPreview with download link for unavailable documents
    - Chunk API endpoint at /api/projects/[id]/chunks/[chunkId] with surrounding context
    - Integration in FindingsTable and FindingCard components
    - Full accessibility support - ARIA labels, keyboard navigation, screen reader support
    - 176 knowledge-explorer tests passing
  e4-6-build-contradictions-view: done
  e4-6-drafted: 2025-11-30
  e4-6-context-ready: 2025-11-30
  e4-6-completed: 2025-11-30
  e4-6-jira-id: SCRUM-53
  e4-6-notes: |
    Contradictions view completed. Key deliverables:
    - Database migration 00023: contradictions table with RLS policies
    - API routes for listing and resolving contradictions
    - ContradictionsView with status filter (All/Unresolved/Resolved/Investigating/Noted)
    - ContradictionCard with side-by-side Finding A vs Finding B comparison
    - ContradictionActions with Accept A/B, Investigate, Add Note buttons with dialogs
    - URL state management for filter persistence
    - 79 component tests passing
    - Integrated into KnowledgeExplorerClient replacing placeholder
  e4-7-detect-contradictions-using-neo4j: done
  e4-7-jira-id: SCRUM-54
  e4-7-drafted: 2025-11-30
  e4-7-context-ready: 2025-11-30
  e4-7-completed: 2025-11-30
  e4-7-completion-notes: |
    - Created ContradictionDetector LLM service (Gemini 2.5 Pro, 70% threshold)
    - Created DetectContradictionsHandler job handler with domain grouping
    - Pre-filtering: same chunk, identical text, date_referenced alignment
    - Batch processing (5 pairs per request) for efficiency
    - Supabase contradiction storage with deduplication
    - Pipeline integration: auto-triggered after analyze-document
    - Manual trigger API: POST /api/projects/[id]/contradictions/detect
    - 33 unit tests passing
  e4-8-build-gap-analysis-view: done
  e4-8-drafted: 2025-11-30
  e4-8-context-ready: 2025-11-30
  e4-8-completed: 2025-11-30
  e4-8-reviewed: 2025-11-30
  e4-8-jira-id: SCRUM-55
  e4-8-completion-notes: |
    - Created Gap types and API client (lib/types/gaps.ts, lib/api/gaps.ts)
    - Created Gap API routes (GET gaps, POST resolve, POST add-to-irl, POST add-finding)
    - Migration 00024: Added metadata JSONB column to deals table for gap resolutions
    - Gap detection: IRL gaps (items without docs), Information gaps (sparse domain coverage)
    - Domain coverage thresholds: Financial 5, Operational 3, Market 3, Legal 2, Technical 2
    - Built GapAnalysisView, GapCard, GapActions components
    - Filter bar with category, status, priority filters + URL state management
    - Statistics bar showing IRL gaps, info gaps, total, active counts
    - Actions: Resolved, N/A (with dialog), Add to IRL, Add Finding (with modal)
    - Integrated into KnowledgeExplorerClient replacing placeholder
    - 96 tests passing across 3 test files
    - Code review APPROVED: All 8 ACs verified, 7 tasks validated, no blocking issues
  e4-9-implement-finding-detail-view-with-full-context: done
  e4-9-drafted: 2025-11-30
  e4-9-context-ready: 2025-11-30
  e4-9-completed: 2025-11-30
  e4-9-jira-id: SCRUM-56
  e4-9-completion-notes: |
    - Created FindingDetailPanel slide-out component with full context display
    - Enhanced GET /api/projects/[id]/findings/[findingId] with document, chunk, related findings
    - Related findings via semantic similarity (match_findings RPC, top 5)
    - ConfidenceReasoning component with visual bar and expandable text
    - ValidationHistory timeline with diff view for edits
    - RelatedFindings list with similarity scores and click navigation
    - Integration in FindingsBrowser with URL state (?findingId=xxx) for deep linking
    - Click handlers added to FindingsTable rows and FindingCard components
    - 173 tests passing with full accessibility support
  e4-10-implement-export-findings-to-csv-excel: done
  e4-10-jira-id: SCRUM-57
  e4-10-drafted: 2025-11-30
  e4-10-context-ready: 2025-11-30
  e4-10-completed: 2025-11-30
  e4-10-completion-notes: |
    - Created export API route POST /api/projects/[id]/findings/export
    - CSV export with csv-stringify (UTF-8 BOM for Excel compatibility)
    - Excel export with exceljs (styled headers, freeze panes, color-coded cells)
    - ExportDropdown component with CSV/Excel options, loading state, accessibility
    - Added exportFindings function to lib/api/findings.ts
    - Integrated into FindingsBrowser toolbar with filter-aware export
    - 5000 finding limit with warning for large exports
    - 23 tests passing (19 component + 4 API)
  # E4.11 was duplicate of E4.7 - removed from epics.md on 2025-11-30
  # Stories renumbered: E4.12→E4.11, E4.13→E4.12, E4.14→E4.13
  e4-11-build-bulk-actions-for-finding-management: done
  e4-11-jira-id: SCRUM-59
  e4-11-drafted: 2025-11-30
  e4-11-context-ready: 2025-11-30
  e4-11-completed: 2025-11-30
  e4-11-note: "Renumbered from E4.12 after duplicate E4.11 removal"
  e4-11-completion-notes: |
    - Created useSelectionState hook for checkbox selection state management
    - Created useBulkUndo hook for bulk undo with 5-second timeout
    - Created SelectionToolbar floating component with selection count
    - Created BulkActionsDropdown with validate/reject/export options
    - Created BulkConfirmDialog for bulk action confirmation
    - Created UndoToast notification component
    - Created batch API endpoint POST /api/projects/[id]/findings/batch
    - Added checkboxes to FindingsTable and FindingCard components
    - Integration with FindingsBrowser for full bulk action workflow
    - 110+ new tests (hooks, components, API) - 829 total tests passing
    - Build passing with all TypeScript checks
  e4-12-implement-export-findings-feature-advanced: done
  e4-12-jira-id: SCRUM-60
  e4-12-drafted: 2025-11-30
  e4-12-context-ready: 2025-11-30
  e4-12-completed: 2025-11-30
  e4-12-note: "Renumbered from E4.13 after duplicate E4.11 removal"
  e4-12-completion-notes: |
    - Created ExportModal component with format selection (CSV, Excel, Report)
    - Field selection UI with Select All/Deselect All buttons
    - Export scope selection (All findings, Filtered findings, Selected findings)
    - Progress indicator for large exports (>500 findings)
    - Export history with localStorage and re-download capability (1-hour expiry)
    - Report format generating formatted HTML grouped by domain with statistics
    - Updated export API route to support field selection, scope, and report format
    - Integrated ExportModal into FindingsBrowser replacing ExportDropdown
    - 62 tests passing (29 API + 33 component)
    - Build passing with all TypeScript checks
  e4-13-build-real-time-knowledge-graph-updates: done
  e4-13-jira-id: SCRUM-61
  e4-13-drafted: 2025-11-30
  e4-13-context-ready: 2025-11-30
  e4-13-completed: 2025-11-30
  e4-13-note: "Renumbered from E4.14 after duplicate E4.11 removal. Last story in Epic 4."
  e4-13-completion-notes: |
    - Created useFindingsRealtime hook for findings table subscriptions
    - Created useContradictionsRealtime hook for contradictions table subscriptions
    - Created useKnowledgeExplorerRealtime composite hook with auto-refresh toggle
    - Created ConnectionStatusIndicator (green/yellow/red dot with tooltip)
    - Created AutoRefreshToggle with localStorage persistence and keyboard shortcut
    - Created RealtimeToastHandler for toast notifications on new findings/contradictions
    - Created switch.tsx shadcn/ui component (was missing)
    - Integrated into KnowledgeExplorerClient with badge count updates
    - 100ms debouncing, exponential backoff reconnection, subscription cleanup
    - Comprehensive tests: hook unit tests, component tests, integration tests
    - Build passing with all TypeScript checks
  epic-4-retrospective: done
  epic-4-retrospective-notes: |
    Completed: 2025-11-30
    Document: docs/sprint-artifacts/retrospectives/epic-E4-retrospective.md
    Key outcomes:
    - 7 blocking prerequisites identified for Epic 5
    - Agent behavior framework needed before E5.2
    - Hybrid search architecture (pgvector + Neo4j) required
    - LLM integration test strategy to be created
    - Supabase types to be regenerated

  # ===================
  # EPIC 5 BLOCKING PREREQUISITES
  # ===================
  # These must be completed BEFORE starting any Epic 5 stories
  # Identified in Epic 4 retrospective (2025-11-30)
  epic-5-prerequisites:
    status: done
    completed: 2025-11-30
    created: 2025-11-30
    source: docs/sprint-artifacts/retrospectives/epic-E4-retrospective.md
    deliverable: docs/agent-behavior-spec.md
    items:
      - id: P1
        title: Hybrid/Agentic Search Architecture
        status: done
        completed: 2025-11-30
        priority: critical
        owner: Architect
        deliverable: "docs/agent-behavior-spec.md (Section P1)"
        description: |
          Design search strategy combining pgvector semantic search with Neo4j graph traversal.
          Required for query_knowledge_base tool in E5.2.
          Flow: Semantic search → Graph expansion → Rerank & synthesize
        completion_notes: |
          - Defined two query modes: Fact Retrieval vs Research/Exploration
          - Established conflict vs temporal difference rules
          - Response formatting: never show confidence scores, explain discrepancies naturally
          - Documented SUPERSEDES relationship usage for correction chains
          - Created P8 for correction chain detection (filename patterns MVP)
      - id: P2
        title: Agent Behavior Framework
        status: done
        completed: 2025-11-30
        priority: critical
        owner: PM + Architect
        deliverable: "docs/agent-behavior-spec.md (Section P2)"
        description: |
          Define how agent responds - compact summaries vs detailed reports.
          Adaptive output with max caps (e.g., 500 words summary).
          Structured output via Pydantic models.
        completion_notes: |
          - Core principles: structured, relevant, sourced
          - Adaptive formatting: bullets for lists, prose for narratives
          - Uncertainty handling: explain WHY + offer next step (Q&A, IRL gap)
          - Proactive suggestions: gaps to IRL, Q&A items
          - Source attribution: every claim needs a source with location
      - id: P3
        title: Expected Behavior per Use Case
        status: done
        completed: 2025-11-30
        priority: critical
        owner: PM
        deliverable: "docs/agent-behavior-spec.md (Section P3)"
        description: |
          Document expected agent behavior for different goals.
          Financial analysis mode: Focus on metrics, comparisons, trends.
          Company analysis mode: Focus on operations, team, market position.
          Research mode: Broader exploration, follow-up questions.
        completion_notes: |
          - Intent is INFERRED from query, not explicit mode selection
          - 7 use cases defined: fact lookup, financial deep dive, due diligence check, comparison, synthesis, gap identification, general exploration
          - Meta-commentary rule: one short line max, then deliver content
          - Detailed examples for each use case with expected output format
      - id: P4
        title: Conversation Goal/Mode Framework
        status: done
        completed: 2025-11-30
        priority: critical
        owner: PM + Architect
        deliverable: "docs/agent-behavior-spec.md (Section P4)"
        description: |
          How agent detects intent from query.
          How mode-specific constraints are applied.
          Guide user toward productive outcomes.
        completion_notes: |
          - Multi-turn context: assume context + state assumption, ask if ambiguous
          - Intent detection: summarized from P3, inferred from query patterns
          - Guiding users: DEFERRED to post-Epic 5 testing and iteration
          - Conversation state: stored in conversations/messages tables, 10 message context window
      - id: P5
        title: Regenerate Supabase Types
        status: done
        completed: 2025-11-30
        priority: high
        owner: Dev
        deliverable: "Clean types, remove all as any casts"
        description: |
          Run npm run db:types after migrations applied.
          Remove (supabase as any) and as unknown as casts.
          Fix any type errors that surface.
        completion_notes: |
          - Regenerated Supabase types with npm run db:types
          - folders table now in generated types
          - Removed 9 `as any` casts from folders/route.ts and folders/[folderId]/route.ts
          - Remaining casts are legitimate type narrowing (Json → ValidationEvent[])
      - id: P6
        title: Install Missing shadcn/ui Components
        status: done
        completed: 2025-11-30
        priority: medium
        owner: Dev
        deliverable: "npx shadcn@latest add avatar"
        description: |
          Avatar component needed for chat interface.
          Audit for other missing components.
        completion_notes: |
          - Installed avatar component for chat interface
          - Installed popover and command components for chat suggestions/autocomplete
          - Total UI components: 27 (avatar, popover, command added)
      - id: P7
        title: LLM Integration Test Strategy
        status: done
        completed: 2025-11-30
        priority: high
        owner: QA
        deliverable: "docs/agent-behavior-spec.md (Section P7)"
        description: |
          Unit tests use mocked responses (current approach).
          Integration test suite runs manually, hits real APIs.
          Cost controls with token limits.
          Evaluation dataset for search quality.
        completion_notes: |
          - Test pyramid: unit (mocked, CI), integration (live, pre-release), evaluation (periodic)
          - Cost control: 50K tokens budget per integration test run
          - E2E testing scope: tool invocation, prompt behavior, workflow E2E (CIM, Q&A, IRL)
          - 10 curated evaluation queries with expected behaviors
          - Scoring: pass/fail per check, 90% threshold for release
          - Test fixtures: sample project with known docs, findings, contradictions
      - id: P8
        title: Correction Chain Detection
        status: done
        completed: 2025-11-30
        priority: high
        owner: Dev
        deliverable: "docs/agent-behavior-spec.md (Section P8)"
        description: |
          Detect when documents/findings supersede earlier versions.
          MVP: Filename patterns (_CORRECTED, _v2, _FINAL, _updated).
          Future: Content-based detection ("This corrects our earlier...").
          Create SUPERSEDES relationships in Neo4j at upload time.
          Required for accurate query_knowledge_base responses.
        completion_notes: |
          - MVP: Filename pattern detection (_CORRECTED, _v2, _v3, _FINAL, _updated, (1), (2))
          - Implementation: document upload webhook handler
          - Graph updates: SUPERSEDES relationship + mark old findings as superseded
          - Query-time: prefer superseding finding, optionally note update
          - Future: content-based detection, metadata matching (deferred)

  # Epic 5: Conversational Assistant (9 stories - 8 done, 1 deferred)
  # Key Components:
  # - LLM integration via LangChain (model-agnostic: Claude, GPT, Gemini configurable)
  # - LangGraph for conversation workflow orchestration
  # - 11 chat tools for knowledge querying
  # - SSE for real-time streaming responses
  # Prerequisites completed: 2025-11-30 (see docs/agent-behavior-spec.md)
  # Duration: December 1-2, 2025 (2 days)
  epic-5: done
  epic-5-completed: 2025-12-02
  epic-5-notes: |
    8/9 stories completed (E5.8 Chat Export deferred to keep MVP lean).
    Key deliverables:
    - LangChain LLM factory with Anthropic/OpenAI/Google providers
    - LangGraph agent with 11 chat tools
    - Full chat UI with SSE streaming responses
    - Conversation history with multi-turn context
    - Source citations with document preview
    - Quick actions and suggested follow-ups
    - Confidence indicators with P2-compliant reasoning
    - Document upload via chat (drag-drop + file picker)
    - ~400+ tests added across all stories
    Key patterns established:
    - SSE streaming with event types (token, tool_start, tool_end, sources, done)
    - Context management with token-aware truncation
    - Confidence extraction from tool results
  e5-1-integrate-llm-via-langchain-model-agnostic: done
  e5-1-drafted: 2025-12-01
  e5-1-context-ready: 2025-12-01
  e5-1-completed: 2025-12-01
  e5-1-reviewed: 2025-12-02
  e5-1-notes: |
    LLM integration layer completed. Key deliverables:
    - LangChain factory supporting Anthropic, OpenAI, Google providers
    - Environment-based configuration with Zod validation
    - Token counting and cost estimation callbacks
    - Structured output support with Zod schemas
    - 92 unit tests passing, 9 integration tests (skipped by default)
    - Environment variables documented in .env.example
    Code review APPROVED - all 6 ACs verified, no blocking issues
  e5-2-implement-langchain-agent-with-11-chat-tools: done
  e5-2-drafted: 2025-12-01
  e5-2-context-ready: 2025-12-01
  e5-2-completed: 2025-12-01
  e5-2-reviewed: 2025-12-01
  e5-2-notes: |
    LangChain agent with 11 chat tools completed. Key deliverables:
    - All 11 tools implemented: query_knowledge_base, update_knowledge_base, validate_finding,
      update_knowledge_graph, detect_contradictions, find_gaps, get_document_info,
      trigger_analysis, suggest_questions, add_to_qa, create_irl
    - LangGraph integration with createReactAgent from @langchain/langgraph/prebuilt
    - P1 hybrid search architecture in query_knowledge_base
    - P2/P3 compliant system prompt with all 7 inferred intent behaviors
    - SSE streaming support with token-by-token display
    - P7 evaluation harness with 10 test queries and 50K token budget
    - 33 unit tests passing
    Code review APPROVED - all 12 ACs verified, quality score 4/5
  e5-3-build-chat-interface-with-conversation-history: done
  e5-3-drafted: 2025-12-01
  e5-3-context-ready: 2025-12-01
  e5-3-completed: 2025-12-02
  e5-3-notes: |
    Chat interface with conversation history completed. Key deliverables:
    - Database migration for conversations/messages tables with RLS
    - SSE streaming integration with agent executor from E5.2
    - ConversationSidebar with conversation list, responsive design
    - MessageList with auto-scroll and user scroll detection
    - MessageItem with markdown, tool indicators, citations
    - ChatInput with Enter/Shift+Enter keyboard shortcuts
    - useChat hook for SSE streaming state management
    - useConversations hook for conversation CRUD
    - Responsive design: collapsible sidebar desktop, sheet/drawer mobile
  e5-4-implement-source-citation-display-in-messages: done
  e5-4-drafted: 2025-12-02
  e5-4-context-ready: 2025-12-02
  e5-4-completed: 2025-12-02
  e5-4-notes: |
    Source citation display in messages completed. Key deliverables:
    - Citation parser utility (lib/utils/citation-parser.ts) for P2-compliant formats
    - SourceCitationLink component with DocumentPreviewModal integration
    - CitationRenderer component for embedding citations in text
    - Document lookup API endpoint for name → ID resolution
    - Extended SourceCitation type with full metadata support
    - 60 tests passing (parser, components, integration)
    - Mobile-friendly with touch targets, responsive truncation
  e5-5-implement-quick-actions-and-suggested-followups: done
  e5-5-drafted: 2025-12-02
  e5-5-context-ready: 2025-12-02
  e5-5-completed: 2025-12-02
  e5-5-deliverables: |
    - QuickActions component with 4 action buttons (Find Contradictions, Generate Q&A, Summarize Findings, Identify Gaps)
    - FollowUpSuggestions component displaying contextual follow-up question chips
    - useQuickActionAvailability hook for checking document/findings/IRL state
    - Extended useChat hook with suggestedFollowups state and clearSuggestions function
    - Updated ChatInput with initialValue/onValueChange for suggestion population
    - Integrated both components into ChatInterface above input area
    - 51 tests passing (QuickActions: 22, FollowUpSuggestions: 17, useQuickActionAvailability: 12)
    - Responsive design with mobile-friendly button layout and horizontal scroll
  e5-6-add-conversation-context-and-multi-turn-support: done
  e5-6-drafted: 2025-12-02
  e5-6-context-ready: 2025-12-02
  e5-6-implemented: 2025-12-02
  e5-6-reviewed: 2025-12-02
  e5-6-deliverables: |
    - ConversationContextManager class with token-aware context management
    - TokenCounter class with character-based estimation (~4 chars/token)
    - Enhanced system prompt with P4-compliant multi-turn handling rules
    - Context formatting with LangChain BaseMessage conversion
    - Automatic truncation when exceeding token limits (oldest messages first)
    - Integration with chat API route for context loading
    - 34 unit tests covering all context scenarios
    Code review APPROVED - all 9 ACs verified, no issues found
  e5-7-implement-confidence-indicators-and-uncertainty-handling: done
  e5-7-drafted: 2025-12-02
  e5-7-context-ready: 2025-12-02
  e5-7-completed: 2025-12-02
  e5-7-deliverables: |
    - lib/utils/confidence.ts - Confidence extraction and aggregation utilities
    - lib/utils/confidence-reasoning.ts - Natural language reasoning generation (P2 compliant)
    - components/chat/ConfidenceBadge.tsx - High/Medium/Low badge with tooltip
    - components/chat/ConfidenceTooltipContent.tsx - Rich tooltip with contributing factors
    - Enhanced AgentStreamHandler with confidence tracking from tool results
    - MessageConfidence type added to chat types
    - Enhanced prompts.ts with P2-compliant uncertainty handling instructions
    - 43 unit tests for confidence utilities with P2 compliance verification
    - Build verified, all acceptance criteria met
  e5-8-implement-chat-export-functionality: deferred
  e5-8-defer-reason: "Keep MVP lean - export functionality not critical for core agent experience"
  e5-8-defer-date: 2025-12-02
  e5-9-implement-document-upload-via-chat-interface: done
  e5-9-drafted: 2025-12-02
  e5-9-context-ready: 2025-12-02
  e5-9-completed: 2025-12-02
  e5-9-notes: |
    - Created ChatUploadButton, ChatDropZone, ChatUploadStatus components
    - Created useChatUpload hook with XHR progress tracking
    - Created chat upload API endpoint at /api/projects/[id]/chat/upload
    - Integrated with existing useDocumentUpdates for realtime status
    - 72 unit tests passing, build verified
  epic-5-retrospective: done
  epic-5-retrospective-completed: 2025-12-02
  epic-5-retrospective-notes: |
    Completed: 2025-12-02
    Document: docs/sprint-artifacts/retrospectives/epic-E5-retrospective.md
    Key outcomes:
    - 8/9 stories completed (E5.8 Chat Export deferred for MVP lean)
    - 2-day epic duration (fastest yet)
    - Prerequisites P1-P7 investment paid off
    - Neo4j write integration FIXED during retro (knowledge-tools.ts updated)
    - E5.3 unit test coverage noted for future attention
    - IRL/folder architecture clarified and documented:
      * Real GCS folders created from IRL (not virtual)
      * Manual-only IRL checklist tracking
      * PRD, architecture.md, epics.md updated
    Epic 6 blocking prerequisites identified:
    - P1: folders table migration
    - P2: irl_items table migration
    - P3: GCS folder creation utility
    - P4: Regenerate Supabase types

  # Epic 6: IRL Management & Auto-Generation (8 stories)
  # CONTEXTED: 2025-12-02
  # Tech Spec: docs/sprint-artifacts/tech-spec-epic-E6.md
  # Key Decisions:
  # - Real GCS folders (not virtual) created from IRL upload
  # - Manual-only IRL checklist tracking (no auto-status updates)
  # - 4 migrations: folders, irls, irl_items, documents.folder_id
  # - New packages: xlsx, pdfmake, docx
  # Prerequisites from E5 retrospective addressed in tech spec
  epic-6: done
  epic-6-contexted: 2025-12-02
  epic-6-tech-spec: docs/sprint-artifacts/tech-spec-epic-E6.md
  e6-1-build-irl-builder-ui-with-template-selection: done
  e6-1-drafted: 2025-12-02
  e6-1-context-ready: 2025-12-02
  e6-1-completed: 2025-12-02
  e6-1-notes: |
    IRL Builder UI with template selection completed. Key deliverables:
    - 4 industry IRL templates (Tech M&A, Industrial, Pharma, Financial Services)
    - IRL type definitions with Zod validation schemas
    - Template service with caching and dynamic file discovery
    - API endpoints for templates and IRL creation (POST/GET)
    - IRLTemplateCard and IRLTemplateModal UI components
    - IRLTemplateSelector with responsive grid layout
    - Deliverables page with IRL tab
    - 89 tests passing across 5 test files
    Note: Adapted to existing irls table schema (uses 'name' + 'sections' JSONB)
  e6-2-implement-irl-creation-and-editing: done
  e6-2-drafted: 2025-12-02
  e6-2-context-ready: 2025-12-02
  e6-2-completed: 2025-12-03
  e6-2-notes: |
    Implementation was already complete from E6.1 work. Verified and fixed tests.
    Key deliverables (all verified):
    - irl_items table with priority, status, subcategory, notes columns
    - lib/services/irls.ts - Full CRUD service (500 lines)
    - API routes for items, categories, reorder operations
    - IRLBuilder with drag-and-drop (dnd-kit)
    - IRLCategory with inline editing
    - IRLItem with priority/status dropdowns
    - useIRLBuilder hook for state management
    - Deliverables page integration
    - 75 IRL component tests passing
  e6-3-implement-ai-assisted-irl-auto-generation-from-documents: done
  e6-3-drafted: 2025-12-03
  e6-3-context-ready: 2025-12-03
  e6-3-completed: 2025-12-03
  e6-3-notes: |
    Implementation of AI-assisted IRL suggestions via 2 new agent tools.
    Key deliverables:
    - generate_irl_suggestions tool (LLM + template-based suggestions)
    - add_to_irl tool (adds items via IRL service)
    - Agent tool count: 11 → 13
    - Suggestions API endpoint for direct access
    - 60 new tests, 1544 total tests passing
  e6-4-implement-data-room-folder-structure-auto-generation-from-irl: done
  e6-4-drafted: 2025-12-03
  e6-4-started: 2025-12-03
  e6-4-completed: 2025-12-03
  e6-4-notes: |
    All 6 tasks completed. Key deliverables:
    - lib/services/folders.ts - Folder service with CRUD and IRL integration
    - lib/gcs/folder-operations.ts - GCS folder prefix operations
    - POST /api/projects/[id]/irls/[irlId]/generate-folders endpoint
    - "Generate Folders" button in IRL Builder with result dialog
    - GCS prefix creation/deletion on folder create/delete
    - 48 unit tests, E2E tests for IRL→folder flow
    - Data Room integration verified (already existed from E2.2):
      * "+ New Folder" button in FolderTree header
      * Context menu with New Subfolder/Rename/Delete
      * Auto-refresh on folder operations
      * Toast notifications for all operations
    Test count: 1592 tests passing
  e6-5-implement-irl-document-linking-and-progress-tracking: done
  e6-5-completed: 2025-12-03
  e6-5-notes: |
    Simplified from document-linking approach to binary checkbox model.
    Key deliverables:
    - Database migration 00027: fulfilled BOOLEAN column on irl_items
    - IRLChecklistPanel complete rewrite with filter toggle
    - IRLChecklistItem simplified to checkbox toggle
    - toggleIRLItemFulfilled API function
    - calculateIRLFulfilledProgress utility
    - Progress based on fulfilled boolean (manual-only tracking)
    - Filter toggle to show unfulfilled items only
    - Optimistic UI updates with error rollback
    - 17 unit tests for checklist panel
  e6-6-build-irl-export-functionality-excel-csv: done
  e6-6-drafted: 2025-12-03
  e6-6-context-ready: 2025-12-03
  e6-6-done: 2025-12-03
  e6-6-notes: |
    IRL Export Functionality (PDF/Word) implementation complete.
    Key deliverables:
    - lib/services/irl-export.ts with generateIRLPdf and generateIRLDocx
    - API route POST /api/projects/[id]/irls/[irlId]/export
    - IRLExportDropdown component with PDF/Word options
    - Export button integrated into IRLBuilder toolbar
    - exportIRL client function in lib/api/irl.ts
    - 33 tests (17 service + 16 component) all passing
    - Dynamic import for pdfmake to avoid build-time font issues
  # Note: e6-7 (IRL Templates Library) was implemented as part of e6-1
  e6-7-build-irl-checklist-progress-visualization: done
  e6-7-drafted: 2025-12-03
  e6-7-started: 2025-12-03
  e6-7-ready: 2025-12-03
  e6-7-completed: 2025-12-03
  e6-7-deliverables:
    - IRLProgressByCategory type and calculateIRLProgressByCategory() in lib/types/irl.ts
    - IRLProgressBar component (size variants, count/percent labels)
    - IRLProgressSummary component (dashboard-style, fulfilled/unfulfilled breakdown)
    - IRLCategoryProgress component (text/badge/bar variants)
    - IRLCategory updated with category-level progress display
    - IRLBuilder integrated with IRLProgressSummary
    - useIRLBuilder hook extended with fulfilledProgress and progressByCategory
    - 36 new tests (12 unit + 24 component) all passing
  epic-6-retrospective: completed
  epic-6-retrospective-completed: 2025-12-03
  epic-6-completed: 2025-12-03
  epic-6-notes: |
    All 7 stories completed in 2 days (Dec 2-3).
    Key deliverables:
    - IRL Builder with 4 industry templates (Tech M&A, Industrial, Pharma, Financial Services)
    - Drag-and-drop editing with dnd-kit
    - AI-assisted IRL generation (2 new agent tools, 13 total)
    - GCS folder auto-generation from IRL categories
    - Binary checkbox tracking for fulfilled items
    - PDF/Word export with pdfmake and docx
    - Progress visualization with category-level breakdown
    - 250+ new tests, 1,592+ total passing
    Key patterns established:
    - Template-based IRL creation
    - Manual-only checklist tracking
    - Real GCS folders (not virtual)

  # Epic 7: Learning Loop (6 stories)
  # CONTEXTED: 2025-12-07
  # Tech Spec: docs/sprint-artifacts/tech-spec-epic-E7.md
  # Key Decisions:
  # - Few-shot prompt optimization (not fine-tuning)
  # - Source validation flow: Display original citation before accepting corrections
  # - Source document error cascade: When source has errors, flag ALL findings from document
  # - Feature flags for safe rollout (sourceErrorCascadeEnabled, autoFlagDocumentFindings = OFF by default)
  # - Document reliability tracking (trusted, contains_errors, superseded)
  # - Feedback tables: finding_corrections (with source validation fields), validation_feedback, response_edits, edit_patterns, feature_flags
  # - Confidence adjustment: +0.05 per validation, -0.10 per rejection, capped [0.1, 0.95]
  # - Phased rollout strategy (4 phases over 2+ weeks)
  # - pg-boss for weekly background feedback analysis job
  # - Append-only audit trail design for compliance
  # - 7 migrations: 00028-00034 (corrections, validation, edits, patterns, needs_review, doc reliability, feature flags)
  epic-7: contexted
  epic-7-contexted: 2025-12-07
  epic-7-tech-spec: docs/sprint-artifacts/tech-spec-epic-E7.md
  e7-1-implement-finding-correction-via-chat: review
  e7-1-drafted: 2025-12-07
  e7-1-context-ready: 2025-12-07
  e7-1-completed: 2025-12-08
  e7-1-notes: |
    Finding correction via chat completed. Key deliverables:
    - 4 database migrations: finding_corrections table (append-only),
      needs_review/last_corrected_at on findings, document reliability tracking,
      feature_flags table
    - lib/config/feature-flags.ts with safe defaults (cascade/auto-flag OFF)
    - lib/types/feedback.ts with 12+ TypeScript types and validation
    - lib/services/corrections.ts for core CRUD with audit trail
    - lib/services/source-error-cascade.ts for document reliability cascade
    - lib/services/correction-propagation.ts for Neo4j-based impact detection
    - 3 agent tools: correctFindingTool, getFindingSourceTool, getCorrectionHistoryTool
    - 3 API endpoints: /correct, /source, /history
    - All 16 acceptance criteria addressed
    - Build passing, types verified
  e7-2-track-validation-rejection-feedback: backlog
  e7-3-enable-response-editing-and-learning: backlog
  e7-4-build-feedback-incorporation-system: backlog
  e7-5-maintain-comprehensive-audit-trail: backlog
  e7-6-propagate-corrections-to-related-insights: backlog
  epic-7-retrospective: optional

  # Epic 8: Q&A Co-Creation Workflow (8 stories)
  epic-8: backlog
  e8-1-build-qa-list-builder-ui: backlog
  e8-2-implement-ai-assisted-question-generation: backlog
  e8-3-implement-answer-drafting-with-source-citations: backlog
  e8-4-build-collaborative-qa-editing-workflow: backlog
  e8-5-implement-qa-organization-and-categorization: backlog
  e8-6-build-qa-export-word-pdf: backlog
  e8-7-implement-qa-version-control: backlog
  e8-8-build-qa-templates-library: backlog
  epic-8-retrospective: optional

  # Epic 9: CIM Company Overview Creation (CIM v3 Workflow) (9 stories)
  epic-9: backlog
  e9-1-cim-workflow-database-schema-and-state-management: backlog
  e9-2-cim-builder-ui-with-workflow-progress-visualization-and-live-preview: backlog
  e9-3-agent-tool-suggest-narrative-outline: backlog
  e9-4-langgraph-cim-v3-workflow-implementation-14-phases: backlog
  e9-5-content-first-then-visual-workflow: backlog
  e9-6-extreme-visual-precision-generation-and-validation: backlog
  e9-7-continuous-balance-checks-and-coherence-validation: backlog
  e9-8-non-linear-workflow-and-special-commands: backlog
  e9-9-multi-format-export-with-rag-source-citations: backlog
  epic-9-retrospective: optional
